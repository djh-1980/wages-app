{% extends "base.html" %}

{% block title %}System Settings - TVS App{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/settings-modern.css') }}?v={{ range(1000, 9999) | random }}">
{% endblock %}

{% block content %}
    <!-- Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1>
                    <i class="bi bi-gear-fill text-warning"></i>
                    System Settings
                </h1>
                <p>Database management and system configuration</p>
            </div>
        </div>
    </div>

    <!-- Status Message -->
    <div id="settingsStatus" style="display: none;"></div>

    <!-- System Settings -->
    <div class="settings-container">
        <div class="settings-section">
            <div class="settings-cards">
                <!-- Database Statistics -->
                <div class="settings-card">
                    <div class="card-header">
                        <h5><i class="bi bi-database me-2"></i>Database Statistics</h5>
                    </div>
                    <div class="card-body">
                        <div class="db-stats-grid">
                            <div class="db-stat-item">
                                <div class="db-stat-value text-primary" id="dbPayslips">-</div>
                                <div class="db-stat-label">Payslips</div>
                            </div>
                            <div class="db-stat-item">
                                <div class="db-stat-value text-success" id="dbRunSheets">-</div>
                                <div class="db-stat-label">Run Sheets</div>
                            </div>
                            <div class="db-stat-item">
                                <div class="db-stat-value text-info" id="dbJobs">-</div>
                                <div class="db-stat-label">Jobs</div>
                            </div>
                            <div class="db-stat-item">
                                <div class="db-stat-value text-warning" id="dbSize">-</div>
                                <div class="db-stat-label">DB Size</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Company Year Configuration -->
                <div class="settings-card">
                    <div class="card-header">
                        <h5><i class="bi bi-calendar-range me-2"></i>Company Year Configuration</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Configure your company's fiscal year settings for accurate week calculations</p>
                        
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Company Year Start Date</label>
                                <input type="text" class="form-control" id="companyYearStart" placeholder="DD/MM/YYYY">
                                <small class="text-muted">The Sunday when your company year starts</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Current Company Year</label>
                                <input type="text" class="form-control" id="currentCompanyYear" readonly>
                                <small class="text-muted">Automatically calculated</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Current Week Number</label>
                                <input type="text" class="form-control" id="currentWeekNumber" readonly>
                                <small class="text-muted">Current week in company year</small>
                            </div>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <button class="btn btn-primary w-100" onclick="saveCompanyYear()">
                                    <i class="bi bi-save me-2"></i>Save Configuration
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-outline-secondary w-100" onclick="loadCompanyYear()">
                                    <i class="bi bi-arrow-repeat me-2"></i>Refresh
                                </button>
                            </div>
                        </div>
                        
                        <div id="companyYearStatus" class="mt-3" style="display: none;"></div>
                    </div>
                </div>

                <!-- Backup & Restore -->
                <div class="settings-card">
                    <div class="card-header">
                        <h5><i class="bi bi-shield-check me-2"></i>Backup & Restore</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <button class="btn btn-primary w-100" onclick="backupDatabase()">
                                    <i class="bi bi-download me-2"></i>Create Backup
                                </button>
                                <small class="text-muted d-block mt-2 text-center">Creates a timestamped backup</small>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-success w-100" onclick="document.getElementById('uploadBackupInput').click()">
                                    <i class="bi bi-upload me-2"></i>Upload Backup
                                </button>
                                <input type="file" id="uploadBackupInput" accept=".db,.db.gz,.gz" style="display: none;" onchange="uploadBackup(this)">
                                <small class="text-muted d-block mt-2 text-center">Upload a database backup file</small>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-outline-primary w-100" onclick="loadBackupsList()">
                                    <i class="bi bi-arrow-repeat me-2"></i>Refresh List
                                </button>
                                <small class="text-muted d-block mt-2 text-center">Reload available backups</small>
                            </div>
                        </div>
                        
                        <!-- Available Backups -->
                        <div id="backupsListContainer" class="mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <strong>Available Backups:</strong>
                                <span id="backupsCount" class="badge bg-secondary">Loading...</span>
                            </div>
                            <div id="backupsList" class="backup-list">
                                <div class="text-center py-3 text-muted">
                                    <div class="spinner-border spinner-border-sm me-2"></div>
                                    Loading backups...
                                </div>
                            </div>
                        </div>
                        
                        <div id="backupStatus" class="mt-3" style="display: none;"></div>
                    </div>
                </div>

                <!-- Database Maintenance -->
                <div class="settings-card">
                    <div class="card-header">
                        <h5><i class="bi bi-wrench me-2"></i>Database Maintenance</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <button class="btn btn-outline-success w-100" onclick="optimizeDatabase()">
                                    <i class="bi bi-speedometer2 me-2"></i>Optimize Database
                                </button>
                                <small class="text-muted d-block mt-2 text-center">Vacuum and optimize for better performance</small>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-outline-info w-100" onclick="validateDatabase()">
                                    <i class="bi bi-check-circle me-2"></i>Validate Integrity
                                </button>
                                <small class="text-muted d-block mt-2 text-center">Check database for errors</small>
                            </div>
                        </div>
                        <div id="maintenanceStatus" class="mt-3" style="display: none;"></div>
                    </div>
                </div>

                <!-- Housekeeping -->
                <div class="settings-card">
                    <div class="card-header">
                        <h5><i class="bi bi-broom me-2"></i>Housekeeping</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Data maintenance and cleanup tools for imported runsheets</p>
                        
                        <!-- Re-parse Runsheets -->
                        <div class="mb-4">
                            <h6><i class="bi bi-arrow-repeat me-2"></i>Re-parse Runsheets</h6>
                            <p class="text-muted small">Re-run the improved parser on existing runsheets to update addresses and job details</p>
                            
                            <div class="row g-3 mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="reparseStartDate">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">End Date</label>
                                    <input type="date" class="form-control" id="reparseEndDate">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">&nbsp;</label>
                                    <button class="btn btn-primary w-100" onclick="reparseRunsheets()">
                                        <i class="bi bi-play-circle me-2"></i>Re-parse Range
                                    </button>
                                </div>
                            </div>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <button class="btn btn-outline-primary w-100" onclick="reparseRecentRunsheets()">
                                        <i class="bi bi-clock me-2"></i>Re-parse Last 7 Days
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button class="btn btn-outline-secondary w-100" onclick="reparseSpecificDate()">
                                        <i class="bi bi-calendar-day me-2"></i>Re-parse Today
                                    </button>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <!-- Address Validation -->
                        <div class="mb-4">
                            <h6><i class="bi bi-check-square me-2"></i>Address Validation</h6>
                            <p class="text-muted small">Clean up addresses by removing phone numbers, duplicates, and formatting issues</p>
                            
                            <div class="row g-3 mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Validation Date</label>
                                    <input type="date" class="form-control" id="validationDate">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Recent Days</label>
                                    <select class="form-select" id="validationDays">
                                        <option value="1">Last 1 day</option>
                                        <option value="7" selected>Last 7 days</option>
                                        <option value="14">Last 14 days</option>
                                        <option value="30">Last 30 days</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">&nbsp;</label>
                                    <button class="btn btn-success w-100" onclick="validateAddresses()">
                                        <i class="bi bi-check-circle me-2"></i>Validate Addresses
                                    </button>
                                </div>
                            </div>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <button class="btn btn-outline-success w-100" onclick="validateSpecificDate()">
                                        <i class="bi bi-calendar-check me-2"></i>Validate Specific Date
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button class="btn btn-outline-warning w-100" onclick="validateAllAddresses()">
                                        <i class="bi bi-globe me-2"></i>Validate All Addresses
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div id="housekeepingStatus" class="mt-3" style="display: none;"></div>
                    </div>
                </div>

                <!-- Customer Mapping -->
                <div class="settings-card">
                    <div class="card-header">
                        <h5><i class="bi bi-diagram-3 me-2"></i>Customer Mapping</h5>
                        <p class="mb-0 text-muted">Group related customers together for consolidated reporting</p>
                    </div>
                    <div class="card-body">
                        <!-- Stats Row -->
                        <div class="row mb-4" id="mappingStats">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="h4 mb-1 text-primary" id="totalMappings">-</div>
                                    <small class="text-muted">Total Mappings</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="h4 mb-1 text-success" id="uniqueMapped">-</div>
                                    <small class="text-muted">Mapped Groups</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="h4 mb-1 text-info" id="totalCustomers">-</div>
                                    <small class="text-muted">Total Customers</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="h4 mb-1 text-warning" id="unmappedCustomers">-</div>
                                    <small class="text-muted">Unmapped</small>
                                </div>
                            </div>
                        </div>

                        <!-- Search and Filter -->
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="customerSearch" placeholder="Search customers...">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select" id="customerFilter">
                                    <option value="all">All Customers</option>
                                    <option value="unmapped">Unmapped Only</option>
                                    <option value="mapped">Mapped Only</option>
                                </select>
                            </div>
                        </div>

                        <!-- Customer List -->
                        <div class="row" id="customersList">
                            <div class="col-12 text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading customers...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading customer list...</p>
                            </div>
                        </div>

                        <div id="customerMappingStatus" class="mt-3" style="display: none;"></div>
                    </div>
                </div>

                <!-- Edit Group Modal -->
                <div class="modal fade" id="editGroupModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Edit Group</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <!-- Group Name -->
                                <div class="mb-4">
                                    <label for="editGroupName" class="form-label">Group Name</label>
                                    <input type="text" class="form-control" id="editGroupName" placeholder="Enter group name">
                                </div>
                                
                                <!-- Current Customers in Group -->
                                <div class="mb-4">
                                    <h6>Customers in this group:</h6>
                                    <div id="editGroupCurrentCustomers" class="border rounded p-3 bg-light" style="max-height: 200px; overflow-y: auto;">
                                        <!-- Current customers will be loaded here -->
                                    </div>
                                </div>
                                
                                <!-- Add Customers -->
                                <div class="mb-3">
                                    <h6>Add customers to group:</h6>
                                    <div class="input-group mb-2">
                                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                                        <input type="text" class="form-control" id="editGroupSearchCustomers" placeholder="Search customers to add...">
                                    </div>
                                    <div id="editGroupAvailableCustomers" class="border rounded p-2" style="max-height: 150px; overflow-y: auto; display: none;">
                                        <!-- Available customers will be loaded here -->
                                    </div>
                                </div>
                                
                                <div id="editGroupError" class="alert alert-danger d-none"></div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="confirmEditGroup">Save Changes</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Delete Group Modal -->
                <div class="modal fade" id="deleteGroupModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Delete Group</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <strong>Warning:</strong> This will delete the group "<span id="deleteGroupName"></span>" and ungroup all customers in this group.
                                </div>
                                <p>Are you sure you want to continue? This action cannot be undone.</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-danger" id="confirmDeleteGroup">Delete Group</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Actions -->
                <div class="settings-card">
                    <div class="card-header">
                        <h5><i class="bi bi-tools me-2"></i>System Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <button class="btn btn-outline-warning w-100" onclick="clearCache()">
                                    <i class="bi bi-trash me-2"></i>Clear Browser Cache
                                </button>
                                <small class="text-muted d-block mt-2 text-center">Clear local storage and reload</small>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-outline-secondary w-100" onclick="viewSystemLogs()">
                                    <i class="bi bi-file-text me-2"></i>View System Logs
                                </button>
                                <small class="text-muted d-block mt-2 text-center">View recent system activity</small>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-outline-danger w-100" onclick="confirmClearExpenses()">
                                    <i class="bi bi-receipt me-2"></i>Clear Expenses
                                </button>
                                <small class="text-muted d-block mt-2 text-center">⚠️ Delete all expense records</small>
                            </div>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-12">
                                <button class="btn btn-outline-danger w-100" onclick="confirmClearAllData()">
                                    <i class="bi bi-exclamation-triangle me-2"></i>Clear All Data
                                </button>
                                <small class="text-muted d-block mt-2 text-center">⚠️ Dangerous operation - Clears ALL database tables</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Information -->
                <div class="settings-card">
                    <div class="card-header">
                        <h5><i class="bi bi-info-square me-2"></i>System Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <table class="table table-sm">
                                    <tr><td><strong>Python Version:</strong></td><td id="pythonVersion">Loading...</td></tr>
                                    <tr><td><strong>Flask Version:</strong></td><td id="flaskVersion">Loading...</td></tr>
                                    <tr><td><strong>Database Type:</strong></td><td>SQLite</td></tr>
                                    <tr><td><strong>Environment:</strong></td><td>Development</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="table table-sm">
                                    <tr><td><strong>Uptime:</strong></td><td id="systemUptime">Loading...</td></tr>
                                    <tr><td><strong>Last Backup:</strong></td><td id="lastBackup">Loading...</td></tr>
                                    <tr><td><strong>Last Sync:</strong></td><td id="lastSync">Loading...</td></tr>
                                    <tr><td><strong>Status:</strong></td><td><span class="badge bg-success">Healthy</span></td></tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div class="modal fade" id="createGroupModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-collection me-2"></i>Create Customer Group
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="groupName" class="form-label">Group Name</label>
                        <input type="text" class="form-control" id="groupName" placeholder="e.g., Fujitsu Services Limited" required>
                        <div class="form-text">This will be the consolidated name for all selected customers</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Selected Customers</label>
                        <div id="selectedCustomersPreview" class="border rounded p-3 bg-light">
                            <p class="text-muted mb-0">No customers selected</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createCustomerGroup()" id="createGroupModalBtn">
                        <i class="bi bi-check-circle me-2"></i>Create Group
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Suggestions Modal -->
    <div class="modal fade" id="suggestionsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-lightbulb me-2"></i>Suggested Customer Mappings
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <p class="text-muted">These suggestions are based on similar customer names found in your system. Review and select which mappings to add.</p>
                    </div>
                    
                    <div id="suggestionsContainer">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading suggestions...</span>
                            </div>
                            <p class="mt-2 text-muted">Analyzing customer names...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" onclick="addSelectedSuggestions()">
                        <i class="bi bi-plus-circle me-2"></i>Add Selected
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/settings-system.js') }}?v={{ range(1000, 9999) | random }}"></script>
{% endblock %}
