{% extends "base.html" %}

{% block title %}Data & Sync Settings - TVS App{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/settings-modern.css') }}?v={{ range(1000, 9999) | random }}">
{% endblock %}

{% block content %}
    <!-- Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1>
                    <i class="bi bi-arrow-repeat text-success"></i>
                    Data & Sync Settings
                </h1>
                <p>Manage Gmail sync, file uploads, and data operations</p>
            </div>
        </div>
    </div>

    <!-- Status Message -->
    <div id="settingsStatus" style="display: none;"></div>

    <!-- Sync Settings -->
    <div class="settings-container">
        <div class="settings-section">
            <div class="settings-cards">
                <!-- Master Sync System -->
                <div class="settings-card">
                    <div class="card-header">
                        <h5><i class="bi bi-lightning-charge me-2"></i>Master Sync System</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <strong>Automated Sync</strong>
                                <div><small class="text-muted">Daily at 8:00 PM & 9:00 PM + Tuesday 9:00 AM</small></div>
                            </div>
                            <button class="btn btn-primary" onclick="runMasterSyncManual()" id="manualSyncBtn">
                                <i class="bi bi-play-circle me-1"></i>Run Sync Now
                            </button>
                        </div>
                        
                        <div class="sync-status-display">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="status-item">
                                        <i class="bi bi-file-earmark-text text-primary"></i>
                                        <div>
                                            <strong>Latest Runsheet</strong>
                                            <div class="text-muted" id="latestRunsheetDate">Loading...</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="status-item">
                                        <i class="bi bi-receipt text-success"></i>
                                        <div>
                                            <strong>Latest Payslip</strong>
                                            <div class="text-muted" id="latestPayslipWeek">Loading...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Live Sync Log -->
                <div class="settings-card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5><i class="bi bi-terminal me-2"></i>Live Sync Log</h5>
                                <small class="text-muted">
                                    <i class="bi bi-circle-fill text-success me-1" style="font-size: 0.5rem;"></i>
                                    Auto-updating every 10 seconds
                                </small>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearSyncLog()">
                                <i class="bi bi-trash"></i> Clear
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="syncLogWindow" class="sync-log-window">
                            <div class="text-muted">Sync log will appear here...</div>
                        </div>
                    </div>
                </div>

                <!-- Gmail Connection -->
                <div class="settings-card">
                    <div class="card-header">
                        <h5><i class="bi bi-envelope me-2"></i>Gmail Connection</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="mb-1">Test your Gmail API connection</p>
                                <small class="text-muted">Verify credentials and authentication status</small>
                            </div>
                            <button type="button" class="btn btn-outline-success" onclick="testGmailConnection()">
                                <i class="bi bi-wifi"></i> Test Connection
                            </button>
                        </div>
                        <div id="gmailTestResults" class="mt-3" style="display: none;"></div>
                    </div>
                </div>

                <!-- File Upload -->
                <div class="settings-card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5><i class="bi bi-cloud-upload me-2"></i>Manual File Upload</h5>
                            <span class="badge bg-info">Historical Files</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Info Banner -->
                        <div class="alert alert-info mb-3">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-info-circle fs-5 me-2"></i>
                                <div>
                                    <strong>Upload Historical Files</strong>
                                    <p class="mb-1 small">Use this to upload older runsheets or payslips that aren't available in your Gmail.</p>
                                    <p class="mb-0 small"><strong>Accepted:</strong> PDF files (runsheets, payslips)</p>
                                </div>
                            </div>
                        </div>

                        <!-- Upload Area -->
                        <div id="fileUploadContainer"></div>

                        <!-- Upload Status -->
                        <div id="uploadStatus" class="mt-3" style="display: none;">
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle me-2"></i>
                                <span id="uploadStatusMessage"></span>
                            </div>
                        </div>

                        <!-- Quick Tips -->
                        <div class="mt-3">
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <small class="text-muted">
                                        <strong>ðŸ’¡ How it works:</strong>
                                        <ul class="mb-0 mt-1">
                                            <li><strong>Upload:</strong> Drop or select PDF files</li>
                                            <li><strong>Auto-detect:</strong> System identifies runsheets vs payslips</li>
                                            <li><strong>Auto-process:</strong> Files are imported to database automatically</li>
                                            <li><strong>Auto-organize:</strong> Files sorted by date and type</li>
                                            <li><strong>Duplicate check:</strong> Existing files are skipped</li>
                                        </ul>
                                    </small>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body p-2 text-center">
                                            <small class="text-muted d-block">Need files from manager?</small>
                                            <button class="btn btn-sm btn-outline-primary mt-2" onclick="copyManagerRequestEmail()">
                                                <i class="bi bi-envelope"></i> Email Template
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/file-upload.js') }}?v={{ range(1000, 9999) | random }}"></script>
<script src="{{ url_for('static', filename='js/settings-sync-simple.js') }}?v={{ range(1000, 9999) | random }}"></script>
{% endblock %}
