{% extends "base.html" %}

{% block title %}Paypoint Stock Management - TVS Wages{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/paypoint.css') }}?v={{ range(1000, 9999) | random }}">
{% endblock %}

{% block content %}
    <!-- Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1>
                    <i class="bi bi-box-seam text-primary"></i>
                    Paypoint Stock Management
                </h1>
                <p>Track van stock, usage, and audit trails</p>
            </div>
            <div class="action-buttons" role="group">
                <button type="button" class="btn btn-primary" onclick="showAddStockModal()">
                    <i class="bi bi-plus-circle"></i> Add Stock
                </button>
                <button type="button" class="btn btn-success" onclick="showUseStockModal()">
                    <i class="bi bi-box-arrow-right"></i> Use Stock
                </button>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row summary-cards" id="summaryCards">
        <div class="col-md-6">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Available</h6>
                            <h3 class="mb-0" id="availableDevices">-</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-check-circle fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Returned</h6>
                            <h3 class="mb-0" id="returnedDevices">-</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-arrow-down-circle fs-2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stock Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="content-card stock-section-card">
                <div class="content-card-header stock-section-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-box-seam"></i>Van Stock</h5>
                        <span class="badge bg-white text-primary stock-count-badge" id="stockCount">0 items</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 paypoint-table-compact" id="devicesTable">
                            <thead class="paypoint-table-header" style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                <tr>
                                    <th style="width: 12%;">Paypoint Type</th>
                                    <th style="width: 18%;">Serial/TID</th>
                                    <th style="width: 18%;">Trace/Stock</th>
                                    <th style="width: 12%;">Status</th>
                                    <th style="width: 28%;">Notes</th>
                                    <th style="width: 12%;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="devicesTableBody" style="background: white;">
                                <tr>
                                    <td colspan="5" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Returns History Section -->
    <div class="row">
        <div class="col-12">
            <div class="content-card returns-section-card">
                <div class="content-card-header returns-section-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-arrow-down-circle"></i>Returns History</h5>
                        <span class="badge bg-white text-primary stock-count-badge" id="returnsCount">0 returns</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 paypoint-table-compact" id="returnsTable">
                            <thead class="paypoint-table-header" style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                <tr>
                                    <th style="width: 10%;">Return Date</th>
                                    <th style="width: 9%;">Job Number</th>
                                    <th style="width: 11%;">Paypoint Type</th>
                                    <th style="width: 13%;">Return Serial/TID</th>
                                    <th style="width: 13%;">Return Trace</th>
                                    <th style="width: 22%;">Location</th>
                                    <th style="width: 11%;">Reason</th>
                                    <th style="width: 11%;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="returnsTableBody" style="background: white;">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Stock Modal -->
<div class="modal fade unified-modal" id="addStockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Stock to Van</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addStockForm">
                    <div class="mb-3">
                        <label for="paypointType" class="form-label">Paypoint Type *</label>
                        <select class="form-select" id="paypointType" required>
                            <option value="">Select type...</option>
                            <option value="PP One">PP One</option>
                            <option value="PP Mini">PP Mini</option>
                            <option value="P-Pod">P-Pod</option>
                            <option value="Rp10">Rp10</option>
                            <option value="Zebra Printer">Zebra Printer</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="serialPtid" class="form-label">Serial / TID *</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="serialPtid" required placeholder="e.g., PP001-2025">
                            <button class="btn btn-outline-primary" type="button" onclick="scanBarcode('serialPtid')" title="Scan barcode">
                                <i class="bi bi-upc-scan"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="traceStock" class="form-label">Trace / Stock *</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="traceStock" required placeholder="e.g., TRC-001">
                            <button class="btn btn-outline-primary" type="button" onclick="scanBarcode('traceStock')" title="Scan barcode">
                                <i class="bi bi-upc-scan"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="deviceNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="deviceNotes" rows="2" placeholder="Optional notes about the device"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addStock()">Add Stock</button>
            </div>
        </div>
    </div>
</div>

<!-- Use Stock Modal (Deploy + Return in one) -->
<div class="modal fade unified-modal" id="useStockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Use Stock for Job</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="useStockForm">
                    <div class="mb-3">
                        <label for="useStockDevice" class="form-label">Device *</label>
                        <select class="form-select" id="useStockDevice" required>
                            <option value="">Select device...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="useStockJobNumber" class="form-label">Job Number *</label>
                        <input type="text" class="form-control" id="useStockJobNumber" required placeholder="e.g., 4289316">
                    </div>
                    <div class="mb-3">
                        <label for="useStockCustomer" class="form-label">Customer</label>
                        <input type="text" class="form-control" id="useStockCustomer" placeholder="e.g., TESCO Express">
                    </div>
                    <div class="mb-3">
                        <label for="useStockLocation" class="form-label">Location</label>
                        <input type="text" class="form-control" id="useStockLocation" placeholder="e.g., 123 High Street, London">
                    </div>
                    <div class="mb-3">
                        <label for="useStockReturnSerial" class="form-label">Return Serial</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="useStockReturnSerial" placeholder="Serial of device being returned">
                            <button class="btn btn-outline-primary" type="button" onclick="scanBarcode('useStockReturnSerial')" title="Scan barcode">
                                <i class="bi bi-upc-scan"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="useStockReturnTrace" class="form-label">Return Trace</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="useStockReturnTrace" placeholder="Return trace number">
                            <button class="btn btn-outline-primary" type="button" onclick="scanBarcode('useStockReturnTrace')" title="Scan barcode">
                                <i class="bi bi-upc-scan"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="useStockReturnReason" class="form-label">Return Reason</label>
                        <select class="form-select" id="useStockReturnReason">
                            <option value="">Select reason...</option>
                            <option value="Job Completed">Job Completed</option>
                            <option value="Device Fault">Device Fault</option>
                            <option value="Customer Request">Customer Request</option>
                            <option value="Upgrade">Upgrade</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="useStockNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="useStockNotes" rows="2" placeholder="Installation and return notes"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="useStock()">Use Stock</button>
            </div>
        </div>
    </div>
</div>

<!-- Barcode Scanner Modal -->
<div class="modal fade" id="barcodeScannerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-upc-scan me-2"></i>Scan Barcode
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="barcodeScannerContainer" style="position: relative;">
                    <video id="barcodeVideo" style="width: 100%; max-height: 400px; background: #000; border-radius: 8px;"></video>
                    <div id="scannerOverlay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; height: 2px; background: red; box-shadow: 0 0 10px red;"></div>
                </div>
                <div id="scannerStatus" class="mt-3 text-center">
                    <p class="text-muted">Position barcode in front of camera</p>
                </div>
                <div id="scannerResult" class="mt-3" style="display: none;">
                    <div class="alert alert-success">
                        <strong>Scanned:</strong> <span id="scannedValue"></span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="{{ url_for('static', filename='js/paypoint.js') }}?v={{ range(1000, 9999) | random }}"></script>
{% endblock %}
