{% extends "base.html" %}

{% block title %}Reports - TVS Wages Management{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/reports.css') }}">
{% endblock %}

{% block content %}
    <!-- Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1>
                    <i class="bi bi-file-earmark-bar-graph text-primary"></i>
                    Comprehensive Reports
                </h1>
                <p>Analyze earnings, jobs, and performance metrics</p>
            </div>
        </div>
    </div>

    <!-- Report Tabs -->
    <div class="row">
        <div class="col-12">
            <div class="card table-card">
                <div class="card-body">
                    <ul class="nav nav-pills" id="reportTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="weekly-summary-tab" data-bs-toggle="pill" data-bs-target="#weekly-summary" type="button">
            <i class="bi bi-calendar-week"></i> Weekly Summary
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="report-generator-tab" data-bs-toggle="pill" data-bs-target="#report-generator" type="button">
            <i class="bi bi-file-earmark-bar-graph"></i> Report Generator
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="mileage-tab" data-bs-toggle="pill" data-bs-target="#mileage" type="button">
            <i class="bi bi-speedometer"></i> Mileage
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="discrepancies-tab" data-bs-toggle="pill" data-bs-target="#discrepancies" type="button">
            <i class="bi bi-exclamation-triangle"></i> Discrepancies
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="missing-runsheets-tab" data-bs-toggle="pill" data-bs-target="#missing-runsheets" type="button">
            <i class="bi bi-calendar-x"></i> Missing Run Sheets
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="missing-payslips-tab" data-bs-toggle="pill" data-bs-target="#missing-payslips" type="button">
            <i class="bi bi-file-earmark-x"></i> Missing Payslips
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="reportTabContent">
    
    <!-- Weekly Summary Tab -->
    <div class="tab-pane fade show active" id="weekly-summary" role="tabpanel">
        <!-- Hero Section with Week Navigation -->
        <div class="weekly-hero mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <button class="btn btn-lg btn-outline-light" onclick="previousWeek()">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <div class="text-center text-white">
                    <h2 class="mb-1" id="weekLabel">Loading...</h2>
                    <p class="mb-0 opacity-75">Weekly Performance Report</p>
                </div>
                <button class="btn btn-lg btn-outline-light" onclick="nextWeek()">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
            <div class="text-center mt-3">
                <button class="btn btn-light me-2" onclick="currentWeek()">
                    <i class="bi bi-calendar-today"></i> Jump to Current Week
                </button>
                <button class="btn btn-success" onclick="exportWeeklySummaryPDF()">
                    <i class="bi bi-file-pdf"></i> Export PDF
                </button>
            </div>
        </div>
        
        <!-- Key Metrics Cards -->
        <div class="row summary-cards mb-4" id="weeklySummaryCards">
            <!-- Populated by JavaScript -->
        </div>
        
        <!-- Main Content Grid -->
        <div class="row g-4 mb-4">
            <!-- Status Breakdown -->
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i class="bi bi-clipboard-check text-primary"></i> Status Breakdown
                        </h5>
                        <div id="weeklyStatusBreakdown">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Performance Metrics & Mileage -->
            <div class="col-lg-8">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i class="bi bi-graph-up text-success"></i> Performance Metrics
                        </h5>
                        <div class="row g-3 mb-4" id="weeklyMetrics">
                            <!-- Populated by JavaScript -->
                        </div>
                        <hr>
                        <h6 class="mb-3">
                            <i class="bi bi-speedometer2 text-primary"></i> Mileage Summary
                        </h6>
                        <div class="row g-3" id="weeklyMileageSummary">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Daily Breakdown -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title mb-4">
                    <i class="bi bi-calendar-week text-info"></i> Daily Breakdown
                </h5>
                <div class="mobile-table-container">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mobile-scrollable-table">
                        <thead class="table-light">
                            <tr>
                                <th>Day</th>
                                <th>Date</th>
                                <th class="text-center">Jobs</th>
                                <th class="text-center">Completed</th>
                                <th class="text-center">Extra</th>
                                <th class="text-center">DNCO</th>
                                <th class="text-center">Pending</th>
                                <th class="text-end">Earnings</th>
                                <th class="text-end">Mileage</th>
                                <th class="text-end">Fuel</th>
                            </tr>
                        </thead>
                        <tbody id="weeklyDailyBreakdown">
                            <!-- Populated by JavaScript -->
                        </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Top Customers & Job Types -->
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i class="bi bi-building text-warning"></i> Top 10 Customers
                        </h5>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Customer</th>
                                        <th class="text-center">Jobs</th>
                                        <th class="text-end">Earnings</th>
                                    </tr>
                                </thead>
                                <tbody id="weeklyTopCustomers">
                                    <!-- Populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i class="bi bi-tools text-danger"></i> Top Job Types
                        </h5>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Job Type</th>
                                        <th class="text-end">Count</th>
                                    </tr>
                                </thead>
                                <tbody id="weeklyJobTypes">
                                    <!-- Populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Overview Tab -->
    <div class="tab-pane fade" id="overview" role="tabpanel">
        <!-- Summary Cards -->
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body">
                        <h6 class="text-muted mb-2">Total Earnings</h6>
                        <h3 class="mb-0" id="overviewTotalEarnings">£0.00</h3>
                        <small class="text-success"><i class="bi bi-arrow-up"></i> All time</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body">
                        <h6 class="text-muted mb-2">Total Jobs</h6>
                        <h3 class="mb-0" id="overviewTotalJobs">0</h3>
                        <small class="text-info"><i class="bi bi-briefcase"></i> Completed</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body">
                        <h6 class="text-muted mb-2">Avg Per Job</h6>
                        <h3 class="mb-0" id="overviewAvgPerJob">£0.00</h3>
                        <small class="text-warning"><i class="bi bi-calculator"></i> Average</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card">
                    <div class="card-body">
                        <h6 class="text-muted mb-2">Working Days</h6>
                        <h3 class="mb-0" id="overviewWorkingDays">0</h3>
                        <small class="text-primary"><i class="bi bi-calendar-check"></i> Days</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Charts -->
        <div class="row g-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Monthly Trends</h5>
                        <div class="chart-container">
                            <canvas id="monthlyTrendsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Job Status Breakdown</h5>
                        <div class="chart-container-small">
                            <canvas id="jobStatusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Jobs vs Earnings Correlation Tab -->
    <div class="tab-pane fade" id="correlation" role="tabpanel">
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Jobs vs Earnings Analysis</h5>
                <p class="text-muted">See how your completed jobs correlate with your earnings over time</p>
                
                <!-- Date Range Filter -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <label class="form-label">From Date</label>
                        <input type="date" class="form-control" id="correlationFromDate">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">To Date</label>
                        <input type="date" class="form-control" id="correlationToDate">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary w-100" onclick="loadCorrelationData()">
                            <i class="bi bi-search"></i> Analyze
                        </button>
                    </div>
                </div>
                
                <div class="chart-container-large">
                    <canvas id="correlationChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Correlation Stats -->
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Average Earnings per Job</h6>
                        <h3 id="avgEarningsPerJob">£0.00</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Best Day (Jobs)</h6>
                        <h3 id="bestDayJobs">-</h3>
                        <small class="text-muted" id="bestDayJobsCount">0 jobs</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Best Day (Earnings)</h6>
                        <h3 id="bestDayEarnings">-</h3>
                        <small class="text-muted" id="bestDayEarningsAmount">£0.00</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Wages Reports Tab -->
    <div class="tab-pane fade" id="wages-reports" role="tabpanel">
        <div class="row g-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-wallet2 text-primary"></i> Wages Reports
                        </h5>
                        <p class="card-text text-muted">Generate detailed reports on your earnings and payslips.</p>
                
                        <div class="list-group list-group-flush">
                            <a href="#" class="list-group-item list-group-item-action" onclick="generateTaxYearReport(); return false;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-calendar-range text-primary"></i>
                                        <strong>Tax Year Summary</strong>
                                        <br>
                                        <small class="text-muted">Earnings breakdown by tax year</small>
                                    </div>
                                    <i class="bi bi-chevron-right"></i>
                                </div>
                            </a>
                            
                            <a href="#" class="list-group-item list-group-item-action" onclick="generateMonthlyReport(); return false;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-calendar-month text-success"></i>
                                        <strong>Monthly Breakdown</strong>
                                        <br>
                                        <small class="text-muted">Earnings by month</small>
                                    </div>
                                    <i class="bi bi-chevron-right"></i>
                                </div>
                            </a>
                            
                            <a href="#" class="list-group-item list-group-item-action" onclick="generateClientReport(); return false;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-building text-info"></i>
                                        <strong>Client Analysis</strong>
                                        <br>
                                        <small class="text-muted">Earnings by client</small>
                                    </div>
                                    <i class="bi bi-chevron-right"></i>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-graph-up text-success"></i> Wage Trends
                        </h5>
                        <div class="chart-container">
                            <canvas id="wagesTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Run Sheets Reports Tab -->
    <div class="tab-pane fade" id="runsheets-reports" role="tabpanel">
        <div class="row g-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-calendar-check text-success"></i> Run Sheets Reports
                        </h5>
                        <p class="card-text text-muted">Analyze your job completion and performance.</p>
                        
                        <div class="list-group list-group-flush">
                            <a href="#" class="list-group-item list-group-item-action" onclick="generateCustomerReport(); return false;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-people text-primary"></i>
                                        <strong>Customer Analysis</strong>
                                        <br>
                                        <small class="text-muted">Jobs by customer</small>
                                    </div>
                                    <i class="bi bi-chevron-right"></i>
                                </div>
                            </a>
                            
                            <a href="#" class="list-group-item list-group-item-action" onclick="generateActivityReport(); return false;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-activity text-success"></i>
                                        <strong>Activity Breakdown</strong>
                                        <br>
                                        <small class="text-muted">Jobs by activity type</small>
                                    </div>
                                    <i class="bi bi-chevron-right"></i>
                                </div>
                            </a>
                            
                            <a href="#" class="list-group-item list-group-item-action" onclick="generateMissingDatesReport(); return false;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-calendar-x text-warning"></i>
                                        <strong>Missing Dates</strong>
                                        <br>
                                        <small class="text-muted">Identify gaps in run sheets</small>
                                    </div>
                                    <i class="bi bi-chevron-right"></i>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-bar-chart text-info"></i> Job Completion Trends
                        </h5>
                        <div class="chart-container">
                            <canvas id="jobCompletionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mileage Tab -->
    <div class="tab-pane fade" id="mileage" role="tabpanel">
        <div class="row g-4">
            <!-- Mileage Summary Cards -->
            <div class="col-12">
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <h6 class="text-muted mb-2">Total Miles</h6>
                                <h3 class="mb-0" id="totalMiles">0</h3>
                                <small class="text-primary"><i class="bi bi-speedometer"></i> All time</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <h6 class="text-muted mb-2">Total Fuel Cost</h6>
                                <h3 class="mb-0" id="totalFuelCost">£0.00</h3>
                                <small class="text-danger"><i class="bi bi-fuel-pump"></i> All time</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <h6 class="text-muted mb-2">Avg Miles/Day</h6>
                                <h3 class="mb-0" id="avgMilesPerDay">0</h3>
                                <small class="text-info"><i class="bi bi-calculator"></i> Working days</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stat-card">
                            <div class="card-body text-center">
                                <h6 class="text-muted mb-2">Cost per Mile</h6>
                                <h3 class="mb-0" id="costPerMile">£0.00</h3>
                                <small class="text-warning"><i class="bi bi-currency-pound"></i> Average</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mileage Allowance Calculator -->
            <div class="col-12">
                <div class="card bg-light border-primary">
                    <div class="card-body">
                        <div class="row align-items-center mb-3">
                            <div class="col-md-6">
                                <h5 class="card-title mb-2">
                                    <i class="bi bi-calculator text-success"></i> HMRC Mileage Allowance
                                </h5>
                                <p class="mb-0 text-muted">
                                    <strong>45p/mile</strong> for first 10,000 miles, then <strong>25p/mile</strong>
                                </p>
                            </div>
                            <div class="col-md-3 text-md-center">
                                <div class="mt-2 mt-md-0">
                                    <div class="text-muted small">Mileage Method</div>
                                    <h4 class="mb-0 text-success" id="taxYearAllowance">£0.00</h4>
                                </div>
                            </div>
                            <div class="col-md-3 text-md-center">
                                <div class="mt-2 mt-md-0">
                                    <div class="text-muted small">Actual Costs</div>
                                    <h4 class="mb-0 text-danger" id="actualCosts">£0.00</h4>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <strong>Tax Rule:</strong> You can claim <strong>EITHER</strong> mileage allowance <strong>OR</strong> actual van costs (fuel, insurance, repairs), not both. 
                            Since you claim actual costs, this is for comparison only.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mileage Charts -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-graph-up text-primary"></i> Monthly Mileage
                            </h5>
                            <select class="form-select form-select-sm" id="mileageYear" style="width: auto;" onchange="loadMileageData()">
                                <option value="">All Years</option>
                                <option value="2026">2026</option>
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                                <option value="2022">2022</option>
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="mileageTrendsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fuel Cost Chart -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-fuel-pump text-danger"></i> Monthly Fuel Cost
                            </h5>
                            <select class="form-select form-select-sm" id="fuelCostYear" style="width: auto;" onchange="loadMileageData()">
                                <option value="">All Years</option>
                                <option value="2026">2026</option>
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                                <option value="2022">2022</option>
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="fuelCostChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Monthly Breakdown Table -->
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-table text-primary"></i> Monthly Breakdown
                            </h5>
                            <div class="d-flex gap-2">
                                <button class="btn btn-success btn-sm" onclick="exportMileageCSV()">
                                    <i class="bi bi-file-earmark-spreadsheet"></i> Export CSV
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="exportMileagePDF()">
                                    <i class="bi bi-file-earmark-pdf"></i> Export PDF
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover table-sm" id="monthlyBreakdownTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="cursor: pointer;" onclick="sortMonthlyTable('month')">Month <i class="bi bi-arrow-down-up"></i></th>
                                        <th style="cursor: pointer;" onclick="sortMonthlyTable('miles')">Miles <i class="bi bi-arrow-down-up"></i></th>
                                        <th style="cursor: pointer;" onclick="sortMonthlyTable('fuel')">Fuel Cost <i class="bi bi-arrow-down-up"></i></th>
                                        <th style="cursor: pointer;" onclick="sortMonthlyTable('efficiency')">Miles/£ <i class="bi bi-arrow-down-up"></i></th>
                                        <th style="cursor: pointer;" onclick="sortMonthlyTable('days')">Working Days <i class="bi bi-arrow-down-up"></i></th>
                                        <th style="cursor: pointer;" onclick="sortMonthlyTable('avg')">Avg Miles/Day <i class="bi bi-arrow-down-up"></i></th>
                                    </tr>
                                </thead>
                                <tbody id="monthlyBreakdownBody">
                                    <tr>
                                        <td colspan="6" class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status"></div>
                                            <p class="mt-2 text-muted">Loading data...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Batch Mileage Estimation -->
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-calculator text-success"></i> Batch Mileage Estimation
                                </h5>
                                <p class="text-muted mb-0">Automatically estimate mileage for days with missing records using route optimization</p>
                            </div>
                            <div class="d-flex gap-2">
                                <select class="form-select form-select-sm" id="batchEstimateYear" style="width: auto;">
                                    <option value="">Select Year</option>
                                    <option value="2026">2026</option>
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                    <option value="2022">2022</option>
                                </select>
                                <button class="btn btn-success btn-sm" id="batchEstimateBtn" onclick="startBatchEstimation()">
                                    <i class="bi bi-lightning-charge"></i> Estimate All Missing
                                </button>
                            </div>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div id="batchEstimationProgress" style="display: none;">
                            <div class="alert alert-info">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span><i class="bi bi-hourglass-split"></i> Estimating mileage...</span>
                                    <span id="progressText">0 / 0</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Preview Table -->
                        <div id="estimationPreview" style="display: none;">
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle"></i> Estimation complete! Review the results below and save when ready.
                            </div>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Jobs</th>
                                            <th class="text-end">Estimated Miles</th>
                                            <th class="text-end">Estimated Time</th>
                                            <th class="text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="estimationPreviewBody">
                                    </tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-end gap-2 mt-3">
                                <button class="btn btn-secondary" onclick="cancelBatchEstimation()">
                                    <i class="bi bi-x-circle"></i> Cancel
                                </button>
                                <button class="btn btn-primary" onclick="saveBatchEstimation()">
                                    <i class="bi bi-save"></i> Save All Estimates
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Discrepancies Tab -->
    <div class="tab-pane fade" id="discrepancies" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <!-- Header -->
                <div class="mb-3">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-exclamation-triangle text-danger"></i> <span id="discrepancyTitle">Wages vs Run Sheets Discrepancies</span>
                    </h5>
                    <p class="text-muted mb-0" id="discrepancyDescription">Compare payslip jobs with run sheet jobs to find mismatches</p>
                </div>
                
                <!-- Report Type Selection - Full Width -->
                <div class="mb-3">
                    <select class="form-select report-type-selector" id="discrepancyType" onchange="changeDiscrepancyType()">
                        <option value="wages">Wages vs Run Sheets</option>
                        <option value="mileage">Missing Mileage</option>
                    </select>
                </div>
                
                <!-- Date Filters Row -->
                <div class="row mb-3">
                    <div class="col-6">
                        <select class="form-select form-select-sm" id="discrepancyYear" onchange="loadDiscrepancyReport()">
                            <option value="">All Years</option>
                            <option value="2026">2026</option>
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                            <option value="2021">2021</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <select class="form-select form-select-sm" id="discrepancyMonth" onchange="loadDiscrepancyReport()">
                            <option value="">All Months</option>
                            <option value="01">January</option>
                            <option value="02">February</option>
                            <option value="03">March</option>
                            <option value="04">April</option>
                            <option value="05">May</option>
                            <option value="06">June</option>
                            <option value="07">July</option>
                            <option value="08">August</option>
                            <option value="09">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                </div>
                
                <!-- Action Buttons Row -->
                <div class="row mb-3">
                    <div class="col-4">
                        <button class="btn btn-primary w-100" onclick="loadDiscrepancyReport()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-danger w-100" onclick="generateDiscrepancyPDF()">
                            <i class="bi bi-file-earmark-pdf"></i> PDF
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-success w-100" onclick="generateDiscrepancyCSV()">
                            <i class="bi bi-file-earmark-spreadsheet"></i> CSV
                        </button>
                    </div>
                </div>
                
                <div class="report-table-container">
                    <div id="discrepancyReportContent">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3 text-muted">Loading discrepancy report...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Missing Run Sheets Tab -->
    <div class="tab-pane fade" id="missing-runsheets" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <!-- Header -->
                <div class="mb-3">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-calendar-x text-warning"></i> Missing Run Sheets
                    </h5>
                    <p class="text-muted mb-0">Find dates where you have no run sheet records</p>
                </div>
                
                <!-- Filters and Actions Row -->
                <div class="row mb-3">
                    <div class="col-8">
                        <select class="form-select" id="missingRunSheetsYear" onchange="loadMissingRunSheets()">
                            <option value="">All Years</option>
                            <option value="2026">2026</option>
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                            <option value="2021">2021</option>
                        </select>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-primary w-100" onclick="loadMissingRunSheets()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                </div>
                
                <div class="report-table-container">
                    <div id="missingRunSheetsContent">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3 text-muted">Analyzing dates...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Missing Payslips Tab -->
    <div class="tab-pane fade" id="missing-payslips" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <!-- Header -->
                <div class="mb-3">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-file-earmark-x text-danger"></i> Missing Payslips
                    </h5>
                    <p class="text-muted mb-0">Find weeks where you have no payslip records</p>
                </div>
                
                <!-- Action Button Row -->
                <div class="mb-3">
                    <button class="btn btn-primary w-100" onclick="loadMissingPayslips()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                
                <div class="report-table-container">
                    <div id="missingPayslipsContent">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3 text-muted">Analyzing weeks...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Export Tab -->
    <div class="tab-pane fade" id="export" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-file-earmark-arrow-down text-info"></i> Export Options
                </h5>
                <p class="card-text text-muted">Export your data in various formats.</p>
                
                <!-- Export Type Selection -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label">Data to Export</label>
                        <select class="form-select" id="exportDataType">
                            <option value="all">All Data (Wages + Run Sheets)</option>
                            <option value="wages">Wages Only</option>
                            <option value="runsheets">Run Sheets Only</option>
                            <option value="correlation">Jobs vs Earnings Analysis</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Date Range</label>
                        <select class="form-select" id="exportDateRange">
                            <option value="all">All Time</option>
                            <option value="year">This Year</option>
                            <option value="month">This Month</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                </div>
                
                <!-- Custom Date Range -->
                <div class="row mb-4" id="customDateRange" style="display: none;">
                    <div class="col-md-6">
                        <label class="form-label">From Date</label>
                        <input type="date" class="form-control" id="exportFromDate">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">To Date</label>
                        <input type="date" class="form-control" id="exportToDate">
                    </div>
                </div>
                
                <!-- Export Buttons -->
                <div class="row g-3">
                    <div class="col-md-4">
                        <button class="btn btn-outline-success w-100" onclick="exportToCSV()">
                            <i class="bi bi-file-earmark-spreadsheet"></i> Export to CSV
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-danger w-100" onclick="exportToPDF()">
                            <i class="bi bi-file-earmark-pdf"></i> Export to PDF
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-primary w-100" onclick="exportToExcel()">
                            <i class="bi bi-file-earmark-excel"></i> Export to Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Report Generator Tab -->
    <div class="tab-pane fade" id="report-generator" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <div class="mb-3">
                    <div>
                        <h5 class="card-title mb-0">
                            <i class="bi bi-file-earmark-bar-graph text-primary"></i> Custom Report Generator
                        </h5>
                        <p class="text-muted mb-0">Generate custom reports with flexible date filtering</p>
                    </div>
                </div>
                
                <!-- Report Type Selection - Full Width -->
                <div class="mb-3">
                    <select class="form-select" id="reportType" onchange="updateReportPreview()">
                        <option value="pending" selected>Pending Jobs</option>
                        <option value="dnco">DNCO Report</option>
                        <option value="earnings_discrepancy">Earnings Discrepancy</option>
                        <option value="paypoint">Paypoint Report</option>
                        <option value="extra_jobs">Extra Jobs</option>
                        <option value="email_audit">Email Confirmations Audit</option>
                        <option value="customer_parsing">Customer Parsing Quality</option>
                    </select>
                </div>
                
                <!-- Customer Selection (only for parsing report) -->
                <div class="mb-3" id="customerSelectionDiv" style="display: none;">
                    <label for="customerSelect" class="form-label">Select Customer:</label>
                    <select class="form-select" id="customerSelect" onchange="generateCustomReport()">
                        <option value="">Loading customers...</option>
                    </select>
                </div>
                
                <!-- Date Filters Row -->
                <div class="row mb-3">
                    <div class="col-3">
                        <select class="form-select form-select-sm" id="yearSelect" onchange="generateCustomReport()">
                        </select>
                    </div>
                    <div class="col-3">
                        <select class="form-select form-select-sm" id="monthSelect" onchange="selectMonth()">
                        </select>
                    </div>
                    <div class="col-3">
                        <select class="form-select form-select-sm" id="weekSelect" onchange="selectWeek()">
                        </select>
                    </div>
                    <div class="col-3">
                        <button class="btn btn-outline-secondary btn-sm w-100" id="sortToggle" onclick="toggleReportSort()" title="Toggle sort order">
                            <i class="bi bi-sort-down" id="sortIcon"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Action Buttons Row - Full Width -->
                <div class="row mb-3">
                    <div class="col-4">
                        <button class="btn btn-primary w-100" onclick="generateCustomReport()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-danger w-100" onclick="exportCustomReportPDF()">
                            <i class="bi bi-file-earmark-pdf"></i> PDF
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-success w-100" onclick="exportCustomReportCSV()">
                            <i class="bi bi-file-earmark-spreadsheet"></i> CSV
                        </button>
                    </div>
                </div>
                
                <div class="mobile-table-container">
                    <div id="customReportOutput">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3 text-muted">Select a report type to generate...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Report Status -->
<div id="reportStatus" class="mt-4" style="display: none;">
    <div class="alert alert-info">
        <i class="bi bi-hourglass-split"></i> Generating report...
    </div>
</div>

<!-- Add Mileage Modal -->
<div class="modal fade" id="addMileageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-speedometer text-primary me-2"></i>
                    <span id="mileageModalTitle">Add Mileage Entry</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="mileageForm">
                    <div class="mb-3">
                        <label class="form-label">Date *</label>
                        <input type="date" class="form-control" id="mileageDate" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Start Mileage *</label>
                                <input type="number" class="form-control" id="startMileage" min="0" step="0.1" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">End Mileage *</label>
                                <input type="number" class="form-control" id="endMileage" min="0" step="0.1" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Total Miles</label>
                        <input type="number" class="form-control" id="totalMiles" step="0.1" readonly>
                        <small class="text-muted">Calculated automatically</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Fuel Cost (£)</label>
                        <input type="number" class="form-control" id="fuelCost" min="0" step="0.01" placeholder="0.00">
                        <small class="text-muted">Optional - leave blank if no fuel purchased</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="mileageNotes" rows="2" placeholder="Optional notes..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveMileageEntry()">
                    <i class="bi bi-check-circle me-1"></i>Save Entry
                </button>
            </div>
        </div>
    </div>
</div>

                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/reports.js') }}"></script>
<script src="{{ url_for('static', filename='js/weekly-summary.js') }}?v={{ range(1000, 9999) | random }}"></script>
<script src="{{ url_for('static', filename='js/verbal-pay.js') }}?v={{ range(1000, 9999) | random }}"></script>
<script src="{{ url_for('static', filename='js/mileage-batch-estimation.js') }}?v={{ range(1000, 9999) | random }}"></script>
<script src="{{ url_for('static', filename='js/mileage-management.js') }}?v={{ range(1000, 9999) | random }}"></script>
{% endblock %}
