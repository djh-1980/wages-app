{% extends "base.html" %}

{% block title %}Settings - TVS App{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/file-upload.css') }}?v={{ range(1000, 9999) | random }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/settings.css') }}?v={{ range(1000, 9999) | random }}">
{% endblock %}

{% block content %}
    <!-- Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1>
                    <i class="bi bi-gear text-primary"></i>
                    Settings
                </h1>
                <p>Manage your profile, preferences, and system configuration</p>
            </div>
            <div class="action-buttons">
                <button class="btn btn-outline-primary" onclick="loadAllSettings()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Navigation Cards -->
    <div class="row summary-cards settings-nav-cards mb-4">
        <div class="col-md-3 col-lg-2">
            <div class="card hover-lift" onclick="showSettingsSection('profile')" style="cursor: pointer;">
                <div class="card-body text-center">
                    <i class="bi bi-person-circle fs-1 text-primary mb-3"></i>
                    <h6 class="card-title mb-2">Profile</h6>
                    <p class="card-text small text-muted mb-0">Personal info & work details</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-lg-2">
            <div class="card hover-lift" onclick="showSettingsSection('sync')" style="cursor: pointer;">
                <div class="card-body text-center">
                    <i class="bi bi-arrow-repeat fs-1 text-success mb-3"></i>
                    <h6 class="card-title mb-2">Data & Sync</h6>
                    <p class="card-text small text-muted mb-0">Gmail sync & file management</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-lg-2">
            <div class="card hover-lift" onclick="showSettingsSection('attendance')" style="cursor: pointer;">
                <div class="card-body text-center">
                    <i class="bi bi-calendar-check fs-1 text-danger mb-3"></i>
                    <h6 class="card-title mb-2">Attendance</h6>
                    <p class="card-text small text-muted mb-0">Track absences & holidays</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-lg-2">
            <div class="card hover-lift" onclick="showSettingsSection('system')" style="cursor: pointer;">
                <div class="card-body text-center">
                    <i class="bi bi-gear-fill fs-1 text-warning mb-3"></i>
                    <h6 class="card-title mb-2">System</h6>
                    <p class="card-text small text-muted mb-0">Database & performance</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-lg-2">
            <div class="card hover-lift" onclick="showSettingsSection('about')" style="cursor: pointer;">
                <div class="card-body text-center">
                    <i class="bi bi-info-circle fs-1 text-info mb-3"></i>
                    <h6 class="card-title mb-2">About</h6>
                    <p class="card-text small text-muted mb-0">Version & system info</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Sections -->
    <div class="content-card">
        <div class="content-card-header unified-tabs">
            <ul class="nav nav-tabs card-header-tabs" id="settingsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab">
                        <i class="bi bi-person-circle"></i> Profile
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="sync-tab" data-bs-toggle="tab" data-bs-target="#sync" type="button" role="tab">
                        <i class="bi bi-arrow-repeat"></i> Data & Sync
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance" type="button" role="tab">
                        <i class="bi bi-calendar-check"></i> Attendance
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="system-tab" data-bs-toggle="tab" data-bs-target="#system" type="button" role="tab">
                        <i class="bi bi-gear-fill"></i> System
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="about-tab" data-bs-toggle="tab" data-bs-target="#about" type="button" role="tab">
                        <i class="bi bi-info-circle"></i> About
                    </button>
                </li>
            </ul>
        </div>
        <div class="content-card-body">
            <div class="tab-content" id="settingsTabContent">
                <!-- Profile Tab -->
                <div class="tab-pane fade show active" id="profile" role="tabpanel">
                    <div class="d-flex align-items-center mb-4">
                        <div class="bg-primary rounded-circle p-3 me-3">
                            <i class="bi bi-person-fill text-white fs-4"></i>
                        </div>
                        <div>
                            <h5 class="mb-0">Profile & Account</h5>
                            <small class="text-muted">Personal information and work details</small>
                        </div>
                    </div>
                    
                    <div class="row g-3 settings-form">
                        <div class="col-md-6">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="userName" placeholder="Daniel Hanson">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="userEmail" placeholder="your@email.com">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="userPhone" placeholder="+44 7XXX XXXXXX">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Hourly Rate (Â£)</label>
                            <input type="number" class="form-control" id="hourlyRate" placeholder="15.00" step="0.01">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Tax Code</label>
                            <input type="text" class="form-control" id="taxCode" placeholder="1257L">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Address</label>
                            <input type="text" class="form-control" id="userAddress" placeholder="Your address">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">NI Number</label>
                            <input type="text" class="form-control" id="niNumber" placeholder="AB123456C">
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="saveProfile()">
                            <i class="bi bi-save me-1"></i>Save Profile
                        </button>
                    </div>
                    
                    <div id="profileStatus" class="mt-3" style="display: none;"></div>
                </div>

                <!-- Data & Sync Tab -->
                <div class="tab-pane fade" id="sync" role="tabpanel">
                    <div class="d-flex align-items-center mb-4">
                        <div class="bg-success rounded-circle p-3 me-3">
                            <i class="bi bi-arrow-repeat text-white fs-4"></i>
                        </div>
                        <div>
                            <h5 class="mb-0">Data & Sync Management</h5>
                            <small class="text-muted">Gmail sync, file uploads, and data operations</small>
                        </div>
                    </div>

                    <!-- Sync Status Cards -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <i class="bi bi-clock-history text-primary fs-4"></i>
                                    <div class="mt-2">
                                        <small class="text-muted d-block">Last Sync</small>
                                        <span id="lastSyncTime" class="fw-semibold">Never</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <i class="bi bi-wifi text-success fs-4"></i>
                                    <div class="mt-2">
                                        <small class="text-muted d-block">Gmail Status</small>
                                        <span id="syncStatusBadge" class="fw-semibold">Checking...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <i class="bi bi-activity text-warning fs-4" id="syncActivityIcon"></i>
                                    <div class="mt-2">
                                        <small class="text-muted d-block">Sync Status</small>
                                        <span id="currentSyncStatus" class="fw-semibold">Idle</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <i class="bi bi-database text-info fs-4"></i>
                                    <div class="mt-2">
                                        <small class="text-muted d-block">Total Records</small>
                                        <span id="totalRecords" class="fw-semibold">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Periodic Sync Control -->
                    <div class="settings-card-section mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-clock me-2"></i>Automatic Sync</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <p class="mb-1">
                                        <strong>Automatic Sync (Every 30 Minutes)</strong>
                                        <span id="autoSyncBadge" class="badge bg-success ms-2" style="display: none;">
                                            <i class="bi bi-check-circle"></i> Active
                                        </span>
                                    </p>
                                    <small class="text-muted">Downloads and imports latest runsheet + payslip from Gmail automatically</small>
                                    <div id="nextSyncTime" class="mt-1" style="display: none;">
                                        <small class="text-info"><i class="bi bi-clock"></i> Next sync: <span id="nextSyncTimeValue">--:--</span></small>
                                    </div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="periodicSyncToggle" onchange="togglePeriodicSync()">
                                    <label class="form-check-label" for="periodicSyncToggle">
                                        <span id="periodicSyncLabel">Enable</span>
                                    </label>
                                </div>
                            </div>
                            <div id="periodicSyncInfo" class="alert alert-info" style="display: none;">
                                <small>
                                    <i class="bi bi-info-circle me-1"></i>
                                    <strong>Auto-Sync Active:</strong> Checks Gmail every 30 minutes for the latest runsheet and payslip, then automatically imports them to the database.
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Manual Sync Actions -->
                    <div class="row g-3 mb-4 settings-actions">
                        <div class="col-md-6">
                            <button class="btn btn-primary btn-lg w-100" onclick="syncLatest()">
                                <i class="bi bi-cloud-download me-2"></i>Sync Latest from Gmail
                            </button>
                            <small class="text-muted d-block mt-2 text-center">Downloads and imports latest runsheet + payslip</small>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-outline-primary btn-lg w-100" onclick="forceSync()">
                                <i class="bi bi-lightning me-2"></i>Force Sync Now
                            </button>
                            <small class="text-muted d-block mt-2 text-center">Triggers auto-sync immediately (if enabled)</small>
                        </div>
                    </div>
                    
                    <div id="syncDataStatus" class="mb-4" style="display: none;"></div>

                    <!-- File Upload Section -->
                    <div class="settings-card-section">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-cloud-upload me-2"></i>Manual File Upload</h6>
                        </div>
                        <div class="card-body">
                            <div id="fileUploadContainer"></div>
                        </div>
                    </div>

                    <!-- Local File Management -->
                    <div class="settings-card-section">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-folder2-open me-2"></i>Local File Management</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3 mb-3">
                                <div class="col-md-4">
                                    <select class="form-select" id="localFileType">
                                        <option value="all">All Files</option>
                                        <option value="payslips">Payslips Only</option>
                                        <option value="runsheets">Runsheets Only</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select" id="localDaysBack">
                                        <option value="7">Last 7 days</option>
                                        <option value="14">Last 14 days</option>
                                        <option value="30">Last 30 days</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-outline-primary w-100" onclick="processLocalFiles()">
                                        <i class="bi bi-play-circle"></i> Process Local Files
                                    </button>
                                </div>
                            </div>
                            <div id="localFilesResults" style="display: none;"></div>
                        </div>
                    </div>

                    <!-- Gmail Connection Test -->
                    <div class="settings-card-section">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-envelope me-2"></i>Gmail Connection</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="mb-1">Test your Gmail API connection</p>
                                    <small class="text-muted">Verify credentials and authentication status</small>
                                </div>
                                <button type="button" class="btn btn-outline-success" onclick="testGmailConnection()">
                                    <i class="bi bi-wifi"></i> Test Connection
                                </button>
                            </div>
                            <div id="gmailTestResults" class="mt-3" style="display: none;"></div>
                        </div>
                    </div>
                </div>

                <!-- Attendance Tab -->
                <div class="tab-pane fade" id="attendance" role="tabpanel">
                    <div class="d-flex align-items-center mb-4">
                        <div class="bg-danger rounded-circle p-3 me-3">
                            <i class="bi bi-calendar-check text-white fs-4"></i>
                        </div>
                        <div>
                            <h5 class="mb-0">Attendance Tracking</h5>
                            <small class="text-muted">Track days you didn't work (holidays, sick days, absences)</small>
                        </div>
                    </div>

                    <!-- Add Attendance Record -->
                    <div class="settings-card-section mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Add Attendance Record</h6>
                        </div>
                        <div class="card-body">
                            <!-- Toggle between single and range -->
                            <div class="btn-group mb-3" role="group">
                                <input type="radio" class="btn-check" name="attendanceMode" id="singleDayMode" checked onchange="toggleAttendanceMode()">
                                <label class="btn btn-outline-primary" for="singleDayMode">
                                    <i class="bi bi-calendar-event"></i> Single Day
                                </label>
                                
                                <input type="radio" class="btn-check" name="attendanceMode" id="rangeDayMode" onchange="toggleAttendanceMode()">
                                <label class="btn btn-outline-primary" for="rangeDayMode">
                                    <i class="bi bi-calendar-range"></i> Date Range
                                </label>
                            </div>

                            <!-- Single Day Form -->
                            <div id="singleDayForm">
                                <div class="row g-3 mb-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Date</label>
                                        <input type="date" class="form-control" id="attendanceDate">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Reason</label>
                                        <select class="form-select" id="attendanceReason">
                                            <option value="Holiday">Holiday</option>
                                            <option value="Sick">Sick Day</option>
                                            <option value="Personal">Personal Day</option>
                                            <option value="Training">Training</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Notes (Optional)</label>
                                        <input type="text" class="form-control" id="attendanceNotes" placeholder="Additional notes...">
                                    </div>
                                </div>
                                <button class="btn btn-primary" onclick="addAttendanceRecord()">
                                    <i class="bi bi-plus-circle me-1"></i>Add Record
                                </button>
                            </div>

                            <!-- Date Range Form -->
                            <div id="rangeDayForm" style="display: none;">
                                <div class="row g-3 mb-3">
                                    <div class="col-md-3">
                                        <label class="form-label">From Date</label>
                                        <input type="date" class="form-control" id="attendanceDateFrom">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">To Date</label>
                                        <input type="date" class="form-control" id="attendanceDateTo">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Reason</label>
                                        <select class="form-select" id="attendanceReasonRange">
                                            <option value="Holiday">Holiday</option>
                                            <option value="Sick">Sick Day</option>
                                            <option value="Personal">Personal Day</option>
                                            <option value="Training">Training</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Notes (Optional)</label>
                                        <input type="text" class="form-control" id="attendanceNotesRange" placeholder="Additional notes...">
                                    </div>
                                </div>
                                <button class="btn btn-primary" onclick="addAttendanceRange()">
                                    <i class="bi bi-calendar-plus me-1"></i>Add Date Range
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Attendance Records List -->
                    <div class="settings-card-section">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="bi bi-list-ul me-2"></i>Attendance Records</h6>
                                <select class="form-select form-select-sm" id="attendanceYearFilter" style="width: auto;" onchange="loadAttendanceRecords()">
                                    <option value="">All Years</option>
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="attendanceRecordsList">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p class="mt-2 text-muted">Loading records...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Tab -->
                <div class="tab-pane fade" id="system" role="tabpanel">
                    <div class="d-flex align-items-center mb-4">
                        <div class="bg-warning rounded-circle p-3 me-3">
                            <i class="bi bi-gear-fill text-white fs-4"></i>
                        </div>
                        <div>
                            <h5 class="mb-0">System Settings</h5>
                            <small class="text-muted">Database management and system configuration</small>
                        </div>
                    </div>

                    <!-- Database Stats -->
                    <div class="settings-card-section">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-database me-2"></i>Database Statistics</h6>
                        </div>
                        <div class="card-body">
                            <div class="db-stats-grid">
                                <div class="db-stat-item">
                                    <div class="db-stat-value text-primary" id="dbPayslips">-</div>
                                    <div class="db-stat-label">Payslips</div>
                                </div>
                                <div class="db-stat-item">
                                    <div class="db-stat-value text-success" id="dbRunSheets">-</div>
                                    <div class="db-stat-label">Run Sheets</div>
                                </div>
                                <div class="db-stat-item">
                                    <div class="db-stat-value text-info" id="dbJobs">-</div>
                                    <div class="db-stat-label">Jobs</div>
                                </div>
                                <div class="db-stat-item">
                                    <div class="db-stat-value text-warning" id="dbSize">-</div>
                                    <div class="db-stat-label">DB Size</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- System Actions -->
                    <div class="settings-card-section">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-tools me-2"></i>System Actions</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3 settings-actions">
                                <div class="col-md-6">
                                    <button class="btn btn-outline-primary w-100" onclick="backupDatabase()">
                                        <i class="bi bi-download me-2"></i>Backup Database
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button class="btn btn-outline-warning w-100" onclick="clearCache()">
                                        <i class="bi bi-trash me-2"></i>Clear Cache
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- About Tab -->
                <div class="tab-pane fade" id="about" role="tabpanel">
                    <div class="d-flex align-items-center mb-4">
                        <div class="bg-info rounded-circle p-3 me-3">
                            <i class="bi bi-info-circle text-white fs-4"></i>
                        </div>
                        <div>
                            <h5 class="mb-0">About TVS Wages</h5>
                            <small class="text-muted">Application information and system details</small>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <h6>Application Info</h6>
                                    <table class="table table-sm">
                                        <tr><td>Version:</td><td>2.0.0</td></tr>
                                        <tr><td>Build:</td><td>2025.11.12</td></tr>
                                        <tr><td>Environment:</td><td>Production</td></tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h6>Features</h6>
                                    <ul class="list-unstyled">
                                        <li><i class="bi bi-check-circle text-success me-2"></i>Gmail Integration</li>
                                        <li><i class="bi bi-check-circle text-success me-2"></i>File Upload System</li>
                                        <li><i class="bi bi-check-circle text-success me-2"></i>Mobile Responsive</li>
                                        <li><i class="bi bi-check-circle text-success me-2"></i>Smart Sync</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/file-upload.js') }}?v={{ range(1000, 9999) | random }}"></script>
<script src="{{ url_for('static', filename='js/settings.js') }}?v={{ range(1000, 9999) | random }}"></script>
<script src="{{ url_for('static', filename='js/settings-helpers.js') }}?v={{ range(1000, 9999) | random }}"></script>
<script src="{{ url_for('static', filename='js/settings-extended.js') }}?v={{ range(1000, 9999) | random }}"></script>
{% endblock %}
