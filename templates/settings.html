{% extends "base.html" %}

{% block title %}Settings - TVS App{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/file-upload.css') }}?v={{ range(1000, 9999) | random }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/settings.css') }}?v={{ range(1000, 9999) | random }}">
{% endblock %}

{% block content %}
    <!-- Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1>
                    <i class="bi bi-gear text-primary"></i>
                    Settings
                </h1>
                <p>Manage your profile, preferences, and system configuration</p>
            </div>
            <div class="action-buttons">
                <button class="btn btn-outline-primary" onclick="loadAllSettings()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Global Status Message -->
    <div id="settingsStatus" style="display: none;"></div>

    <!-- Settings Navigation Cards -->
    <div class="row summary-cards settings-nav-cards mb-4">
        <div class="col-md-3 col-lg-2">
            <div class="card hover-lift" onclick="showSettingsSection('profile')" style="cursor: pointer;">
                <div class="card-body text-center">
                    <i class="bi bi-person-circle fs-1 text-primary mb-3"></i>
                    <h6 class="card-title mb-2">Profile</h6>
                    <p class="card-text small text-muted mb-0">Personal info & work details</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-lg-2">
            <div class="card hover-lift" onclick="showSettingsSection('sync')" style="cursor: pointer;">
                <div class="card-body text-center">
                    <i class="bi bi-arrow-repeat fs-1 text-success mb-3"></i>
                    <h6 class="card-title mb-2">Data & Sync</h6>
                    <p class="card-text small text-muted mb-0">Gmail sync & file management</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-lg-2">
            <div class="card hover-lift" onclick="showSettingsSection('attendance')" style="cursor: pointer;">
                <div class="card-body text-center">
                    <i class="bi bi-calendar-check fs-1 text-danger mb-3"></i>
                    <h6 class="card-title mb-2">Attendance</h6>
                    <p class="card-text small text-muted mb-0">Track absences & holidays</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-lg-2">
            <div class="card hover-lift" onclick="showSettingsSection('system')" style="cursor: pointer;">
                <div class="card-body text-center">
                    <i class="bi bi-gear-fill fs-1 text-warning mb-3"></i>
                    <h6 class="card-title mb-2">System</h6>
                    <p class="card-text small text-muted mb-0">Database & performance</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-lg-2">
            <div class="card hover-lift" onclick="showSettingsSection('about')" style="cursor: pointer;">
                <div class="card-body text-center">
                    <i class="bi bi-info-circle fs-1 text-info mb-3"></i>
                    <h6 class="card-title mb-2">About</h6>
                    <p class="card-text small text-muted mb-0">Version & system info</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Sections -->
    <div class="content-card">
        <div class="content-card-header unified-tabs">
            <ul class="nav nav-tabs card-header-tabs" id="settingsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab">
                        <i class="bi bi-person-circle"></i> Profile
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="sync-tab" data-bs-toggle="tab" data-bs-target="#sync" type="button" role="tab">
                        <i class="bi bi-arrow-repeat"></i> Data & Sync
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance" type="button" role="tab">
                        <i class="bi bi-calendar-check"></i> Attendance
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="system-tab" data-bs-toggle="tab" data-bs-target="#system" type="button" role="tab">
                        <i class="bi bi-gear-fill"></i> System
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="about-tab" data-bs-toggle="tab" data-bs-target="#about" type="button" role="tab">
                        <i class="bi bi-info-circle"></i> About
                    </button>
                </li>
            </ul>
        </div>
        <div class="content-card-body">
            <div class="tab-content" id="settingsTabContent">
                <!-- Profile Tab -->
                <div class="tab-pane fade show active" id="profile" role="tabpanel">
                    <div class="d-flex align-items-center mb-4">
                        <div class="bg-primary rounded-circle p-3 me-3">
                            <i class="bi bi-person-fill text-white fs-4"></i>
                        </div>
                        <div>
                            <h5 class="mb-0">Profile & Account</h5>
                            <small class="text-muted">Personal information and work details</small>
                        </div>
                    </div>
                    
                    <div class="row g-3 settings-form">
                        <div class="col-md-6">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="userName" placeholder="Daniel Hanson">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="userEmail" placeholder="your@email.com">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="userPhone" placeholder="+44 7XXX XXXXXX">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Address Line 1</label>
                            <input type="text" class="form-control" id="addressLine1" placeholder="Street address">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Address Line 2</label>
                            <input type="text" class="form-control" id="addressLine2" placeholder="Apartment, suite, etc. (optional)">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">City</label>
                            <input type="text" class="form-control" id="city" placeholder="City">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Postcode</label>
                            <input type="text" class="form-control" id="postcode" placeholder="LA1 1XX">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">UTR Number</label>
                            <input type="text" class="form-control" id="utrNumber" placeholder="1234567890">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">NI Number</label>
                            <input type="text" class="form-control" id="niNumber" placeholder="AB123456C">
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-primary" onclick="saveProfile()">
                            <i class="bi bi-save me-1"></i>Save Profile
                        </button>
                    </div>
                    
                    <div id="profileStatus" class="mt-3" style="display: none;"></div>
                </div>

                <!-- Data & Sync Tab -->
                <div class="tab-pane fade" id="sync" role="tabpanel">
                    <div class="d-flex align-items-center mb-4">
                        <div class="bg-success rounded-circle p-3 me-3">
                            <i class="bi bi-arrow-repeat text-white fs-4"></i>
                        </div>
                        <div>
                            <h5 class="mb-0">Data & Sync Management</h5>
                            <small class="text-muted">Gmail sync, file uploads, and data operations</small>
                        </div>
                    </div>

                    <!-- Periodic Sync Control - Enhanced -->
                    <div class="settings-card-section mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-clock me-2"></i>Automatic Sync</h6>
                        </div>
                        <div class="card-body">
                            <!-- Main Toggle -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="flex-grow-1">
                                    <p class="mb-1">
                                        <strong>Automatic Sync Service</strong>
                                        <span id="autoSyncBadge" class="badge bg-secondary ms-2">
                                            <i class="bi bi-circle-fill"></i> <span id="autoSyncBadgeText">Checking...</span>
                                        </span>
                                    </p>
                                    <small class="text-muted">Intelligent sync that downloads and imports files automatically</small>
                                    <div id="nextSyncTime" class="mt-1" style="display: none;">
                                        <small class="text-info"><i class="bi bi-clock"></i> Next sync: <span id="nextSyncTimeValue">--:--</span></small>
                                    </div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="periodicSyncToggle" onchange="togglePeriodicSync()">
                                    <label class="form-check-label" for="periodicSyncToggle">
                                        <span id="periodicSyncLabel">Enable</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Sync Controls -->
                            <div id="syncControls" class="row g-2 mb-3" style="display: none;">
                                <div class="col-md-3">
                                    <button class="btn btn-sm btn-outline-primary w-100" onclick="syncLatest()">
                                        <i class="bi bi-cloud-download"></i> Manual Sync
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-sm btn-outline-warning w-100" onclick="pauseSync()" id="pauseSyncBtn">
                                        <i class="bi bi-pause-circle"></i> Pause
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-sm btn-outline-success w-100" onclick="resumeSync()" id="resumeSyncBtn" style="display: none;">
                                        <i class="bi bi-play-circle"></i> Resume
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-sm btn-outline-primary w-100" onclick="showSyncConfig()">
                                        <i class="bi bi-gear"></i> Configure
                                    </button>
                                </div>
                            </div>

                            <!-- Health Status -->
                            <div id="syncHealthStatus" class="alert alert-light border" style="display: none;">
                                <div class="row g-2 text-center">
                                    <div class="col-3">
                                        <i class="bi bi-envelope fs-5" id="gmailHealthIcon"></i>
                                        <div><small id="gmailHealthText">Gmail</small></div>
                                    </div>
                                    <div class="col-3">
                                        <i class="bi bi-database fs-5" id="dbHealthIcon"></i>
                                        <div><small id="dbHealthText">Database</small></div>
                                    </div>
                                    <div class="col-3">
                                        <i class="bi bi-hdd fs-5" id="diskHealthIcon"></i>
                                        <div><small id="diskHealthText">Disk</small></div>
                                    </div>
                                    <div class="col-3">
                                        <i class="bi bi-activity fs-5" id="serviceHealthIcon"></i>
                                        <div><small id="serviceHealthText">Service</small></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Latest Data -->
                            <div id="latestDataContainer" style="display: none;">
                                <hr>
                                <div class="mb-2">
                                    <strong><small>Latest Data Processed</small></strong>
                                </div>
                                <div class="row g-2 text-center">
                                    <div class="col-6">
                                        <div class="p-2 bg-light rounded">
                                            <i class="bi bi-file-earmark-text text-primary"></i>
                                            <div><small class="text-muted">Latest Runsheet</small></div>
                                            <div><strong><small id="latestRunsheetDate">-</small></strong></div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="p-2 bg-light rounded">
                                            <i class="bi bi-receipt text-success"></i>
                                            <div><small class="text-muted">Latest Payslip</small></div>
                                            <div><strong><small id="latestPayslipWeek">-</small></strong></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Sync History -->
                            <div id="syncHistoryContainer" style="display: none;">
                                <hr>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong><small>Recent Sync Activity</small></strong>
                                    <button class="btn btn-sm btn-link" onclick="toggleSyncHistory()">
                                        <i class="bi bi-chevron-down" id="syncHistoryToggleIcon"></i>
                                    </button>
                                </div>
                                <div id="syncHistoryList" style="display: none; max-height: 200px; overflow-y: auto;">
                                    <div class="text-center text-muted py-2">
                                        <small>No recent activity</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sync Configuration Modal -->
                    <div class="modal fade" id="syncConfigModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title"><i class="bi bi-gear me-2"></i>Sync Configuration</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <!-- Sync Schedule -->
                                    <div class="mb-4">
                                        <h6 class="border-bottom pb-2">Sync Schedule</h6>
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Daily Start Time</label>
                                                <input type="time" class="form-control" id="syncStartTime" value="18:00">
                                                <small class="text-muted">When to begin daily runsheet sync</small>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Check Interval (minutes)</label>
                                                <input type="number" class="form-control" id="syncIntervalMinutes" value="15" min="5" max="60">
                                                <small class="text-muted">How often to check for new files</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Payslip Sync Schedule -->
                                    <div class="mb-4">
                                        <h6 class="border-bottom pb-2">Payslip Sync Schedule</h6>
                                        <div class="row g-3">
                                            <div class="col-md-4">
                                                <label class="form-label">Sync Day</label>
                                                <select class="form-select" id="payslipSyncDay">
                                                    <option value="Monday">Monday</option>
                                                    <option value="Tuesday" selected>Tuesday</option>
                                                    <option value="Wednesday">Wednesday</option>
                                                    <option value="Thursday">Thursday</option>
                                                    <option value="Friday">Friday</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">Start Hour</label>
                                                <input type="number" class="form-control" id="payslipSyncStart" value="6" min="0" max="23">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">End Hour</label>
                                                <input type="number" class="form-control" id="payslipSyncEnd" value="14" min="0" max="23">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Selective Sync -->
                                    <div class="mb-4">
                                        <h6 class="border-bottom pb-2">Selective Sync</h6>
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" id="autoSyncRunsheetsEnabled" checked>
                                            <label class="form-check-label" for="autoSyncRunsheetsEnabled">
                                                Auto-sync Runsheets
                                            </label>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="autoSyncPayslipsEnabled" checked>
                                            <label class="form-check-label" for="autoSyncPayslipsEnabled">
                                                Auto-sync Payslips
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Notification Preferences -->
                                    <div class="mb-4">
                                        <h6 class="border-bottom pb-2">Notification Preferences</h6>
                                        <div class="mb-3">
                                            <label class="form-label">Notification Email</label>
                                            <input type="email" class="form-control" id="notificationEmail" placeholder="your@email.com">
                                            <small class="text-muted">Email address to receive sync notifications</small>
                                        </div>
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" id="notifyOnSuccess" checked>
                                            <label class="form-check-label" for="notifyOnSuccess">
                                                Notify on successful sync
                                            </label>
                                        </div>
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" id="notifyOnErrorOnly">
                                            <label class="form-check-label" for="notifyOnErrorOnly">
                                                Only notify on errors
                                            </label>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="notifyOnNewFilesOnly">
                                            <label class="form-check-label" for="notifyOnNewFilesOnly">
                                                Only notify when new files are found
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-primary" onclick="saveSyncConfig()">
                                        <i class="bi bi-save me-1"></i>Save Configuration
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="syncDataStatus" class="mb-4" style="display: none;"></div>

                    <!-- File Upload Section -->
                    <div class="settings-card-section">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="bi bi-cloud-upload me-2"></i>Manual File Upload</h6>
                                <span class="badge bg-info">Historical Files</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Info Banner -->
                            <div class="alert alert-info mb-3">
                                <div class="d-flex align-items-start">
                                    <i class="bi bi-info-circle fs-5 me-2"></i>
                                    <div>
                                        <strong>Upload Historical Files</strong>
                                        <p class="mb-1 small">Use this to upload older runsheets or payslips that aren't available in your Gmail.</p>
                                        <p class="mb-0 small"><strong>Accepted:</strong> PDF files (runsheets, payslips)</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Upload Area -->
                            <div id="fileUploadContainer"></div>

                            <!-- Upload Status -->
                            <div id="uploadStatus" class="mt-3" style="display: none;">
                                <div class="alert alert-success">
                                    <i class="bi bi-check-circle me-2"></i>
                                    <span id="uploadStatusMessage"></span>
                                </div>
                            </div>

                            <!-- Quick Tips -->
                            <div class="mt-3">
                                <div class="row g-3">
                                    <div class="col-md-8">
                                        <small class="text-muted">
                                            <strong>ðŸ’¡ How it works:</strong>
                                            <ul class="mb-0 mt-1">
                                                <li><strong>Upload:</strong> Drop or select PDF files</li>
                                                <li><strong>Auto-detect:</strong> System identifies runsheets vs payslips</li>
                                                <li><strong>Auto-process:</strong> Files are imported to database automatically</li>
                                                <li><strong>Auto-organize:</strong> Files sorted by date and type</li>
                                                <li><strong>Duplicate check:</strong> Existing files are skipped</li>
                                            </ul>
                                        </small>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card bg-light">
                                            <div class="card-body p-2 text-center">
                                                <small class="text-muted d-block">Need files from manager?</small>
                                                <button class="btn btn-sm btn-outline-primary mt-2" onclick="copyManagerRequestEmail()">
                                                    <i class="bi bi-envelope"></i> Email Template
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Gmail Connection Test -->
                    <div class="settings-card-section">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-envelope me-2"></i>Gmail Connection</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="mb-1">Test your Gmail API connection</p>
                                    <small class="text-muted">Verify credentials and authentication status</small>
                                </div>
                                <button type="button" class="btn btn-outline-success" onclick="testGmailConnection()">
                                    <i class="bi bi-wifi"></i> Test Connection
                                </button>
                            </div>
                            <div id="gmailTestResults" class="mt-3" style="display: none;"></div>
                        </div>
                    </div>
                </div>

                <!-- Attendance Tab -->
                <div class="tab-pane fade" id="attendance" role="tabpanel">
                    <div class="d-flex align-items-center mb-4">
                        <div class="bg-danger rounded-circle p-3 me-3">
                            <i class="bi bi-calendar-check text-white fs-4"></i>
                        </div>
                        <div>
                            <h5 class="mb-0">Attendance Tracking</h5>
                            <small class="text-muted">Track days you didn't work (holidays, sick days, absences)</small>
                        </div>
                    </div>

                    <!-- Add Attendance Record -->
                    <div class="settings-card-section mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Add Attendance Record</h6>
                        </div>
                        <div class="card-body">
                            <!-- Toggle between single and range -->
                            <div class="btn-group mb-3" role="group">
                                <input type="radio" class="btn-check" name="attendanceMode" id="singleDayMode" checked onchange="toggleAttendanceMode()">
                                <label class="btn btn-outline-primary" for="singleDayMode">
                                    <i class="bi bi-calendar-event"></i> Single Day
                                </label>
                                
                                <input type="radio" class="btn-check" name="attendanceMode" id="rangeDayMode" onchange="toggleAttendanceMode()">
                                <label class="btn btn-outline-primary" for="rangeDayMode">
                                    <i class="bi bi-calendar-range"></i> Date Range
                                </label>
                            </div>

                            <!-- Single Day Form -->
                            <div id="singleDayForm">
                                <div class="row g-3 mb-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Date</label>
                                        <input type="date" class="form-control" id="attendanceDate">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Reason</label>
                                        <select class="form-select" id="attendanceReason">
                                            <option value="Holiday">Holiday</option>
                                            <option value="Sick">Sick Day</option>
                                            <option value="Personal">Personal Day</option>
                                            <option value="Training">Training</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Notes (Optional)</label>
                                        <input type="text" class="form-control" id="attendanceNotes" placeholder="Additional notes...">
                                    </div>
                                </div>
                                <button class="btn btn-primary" onclick="addAttendanceRecord()">
                                    <i class="bi bi-plus-circle me-1"></i>Add Record
                                </button>
                            </div>

                            <!-- Date Range Form -->
                            <div id="rangeDayForm" style="display: none;">
                                <div class="row g-3 mb-3">
                                    <div class="col-md-3">
                                        <label class="form-label">From Date</label>
                                        <input type="date" class="form-control" id="attendanceDateFrom">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">To Date</label>
                                        <input type="date" class="form-control" id="attendanceDateTo">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Reason</label>
                                        <select class="form-select" id="attendanceReasonRange">
                                            <option value="Holiday">Holiday</option>
                                            <option value="Sick">Sick Day</option>
                                            <option value="Personal">Personal Day</option>
                                            <option value="Training">Training</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Notes (Optional)</label>
                                        <input type="text" class="form-control" id="attendanceNotesRange" placeholder="Additional notes...">
                                    </div>
                                </div>
                                <button class="btn btn-primary" onclick="addAttendanceRange()">
                                    <i class="bi bi-calendar-plus me-1"></i>Add Date Range
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Attendance Records List -->
                    <div class="settings-card-section">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="bi bi-list-ul me-2"></i>Attendance Records</h6>
                                <select class="form-select form-select-sm" id="attendanceYearFilter" style="width: auto;" onchange="loadAttendanceRecords()">
                                    <option value="">All Years</option>
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="attendanceRecordsList">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p class="mt-2 text-muted">Loading records...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Tab -->
                <div class="tab-pane fade" id="system" role="tabpanel">
                    <div class="d-flex align-items-center mb-4">
                        <div class="bg-warning rounded-circle p-3 me-3">
                            <i class="bi bi-gear-fill text-white fs-4"></i>
                        </div>
                        <div>
                            <h5 class="mb-0">System Settings</h5>
                            <small class="text-muted">Database management and system configuration</small>
                        </div>
                    </div>

                    <!-- Database Stats -->
                    <div class="settings-card-section mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-database me-2"></i>Database Statistics</h6>
                        </div>
                        <div class="card-body">
                            <div class="db-stats-grid">
                                <div class="db-stat-item">
                                    <div class="db-stat-value text-primary" id="dbPayslips">-</div>
                                    <div class="db-stat-label">Payslips</div>
                                </div>
                                <div class="db-stat-item">
                                    <div class="db-stat-value text-success" id="dbRunSheets">-</div>
                                    <div class="db-stat-label">Run Sheets</div>
                                </div>
                                <div class="db-stat-item">
                                    <div class="db-stat-value text-info" id="dbJobs">-</div>
                                    <div class="db-stat-label">Jobs</div>
                                </div>
                                <div class="db-stat-item">
                                    <div class="db-stat-value text-warning" id="dbSize">-</div>
                                    <div class="db-stat-label">DB Size</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Backup & Restore -->
                    <div class="settings-card-section mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-shield-check me-2"></i>Backup & Restore</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3 mb-3">
                                <div class="col-md-4">
                                    <button class="btn btn-primary w-100" onclick="backupDatabase()">
                                        <i class="bi bi-download me-2"></i>Create Backup
                                    </button>
                                    <small class="text-muted d-block mt-2 text-center">Creates a timestamped backup of the database</small>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-success w-100" onclick="document.getElementById('uploadBackupInput').click()">
                                        <i class="bi bi-upload me-2"></i>Upload Backup
                                    </button>
                                    <input type="file" id="uploadBackupInput" accept=".db,.db.gz,.gz" style="display: none;" onchange="uploadBackup(this)">
                                    <small class="text-muted d-block mt-2 text-center">Upload a database backup file</small>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-outline-primary w-100" onclick="loadBackupsList()">
                                        <i class="bi bi-arrow-clockwise me-2"></i>Refresh List
                                    </button>
                                    <small class="text-muted d-block mt-2 text-center">Reload available backups</small>
                                </div>
                            </div>
                            
                            <!-- Available Backups -->
                            <div id="backupsListContainer" class="mt-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong>Available Backups:</strong>
                                    <span id="backupsCount" class="badge bg-secondary">Loading...</span>
                                </div>
                                <div id="backupsList" class="list-group" style="max-height: 300px; overflow-y: auto;">
                                    <div class="text-center py-3 text-muted">
                                        <div class="spinner-border spinner-border-sm me-2"></div>
                                        Loading backups...
                                    </div>
                                </div>
                            </div>
                            
                            <div id="backupStatus" class="mt-3" style="display: none;"></div>
                        </div>
                    </div>

                    <!-- Database Maintenance -->
                    <div class="settings-card-section mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-wrench me-2"></i>Database Maintenance</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <button class="btn btn-outline-success w-100" onclick="optimizeDatabase()">
                                        <i class="bi bi-speedometer2 me-2"></i>Optimize Database
                                    </button>
                                    <small class="text-muted d-block mt-2 text-center">Vacuum and optimize for better performance</small>
                                </div>
                                <div class="col-md-6">
                                    <button class="btn btn-outline-info w-100" onclick="validateDatabase()">
                                        <i class="bi bi-check-circle me-2"></i>Validate Integrity
                                    </button>
                                    <small class="text-muted d-block mt-2 text-center">Check database for errors</small>
                                </div>
                            </div>
                            <div id="maintenanceStatus" class="mt-3" style="display: none;"></div>
                        </div>
                    </div>

                    <!-- System Actions -->
                    <div class="settings-card-section">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-tools me-2"></i>System Actions</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <button class="btn btn-outline-warning w-100" onclick="clearCache()">
                                        <i class="bi bi-trash me-2"></i>Clear Browser Cache
                                    </button>
                                    <small class="text-muted d-block mt-2 text-center">Clear local storage and reload</small>
                                </div>
                                <div class="col-md-6">
                                    <button class="btn btn-outline-secondary w-100" onclick="viewSystemLogs()">
                                        <i class="bi bi-file-text me-2"></i>View System Logs
                                    </button>
                                    <small class="text-muted d-block mt-2 text-center">View recent system activity</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- About Tab -->
                <div class="tab-pane fade" id="about" role="tabpanel">
                    <div class="d-flex align-items-center mb-4">
                        <div class="bg-info rounded-circle p-3 me-3">
                            <i class="bi bi-info-circle text-white fs-4"></i>
                        </div>
                        <div>
                            <h5 class="mb-0">About TVS Wages</h5>
                            <small class="text-muted">Application information and system details</small>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <h6>Application Info</h6>
                                    <table class="table table-sm">
                                        <tr><td>Version:</td><td>2.0.0</td></tr>
                                        <tr><td>Build:</td><td>2025.11.12</td></tr>
                                        <tr><td>Environment:</td><td>Production</td></tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h6>Features</h6>
                                    <ul class="list-unstyled">
                                        <li><i class="bi bi-check-circle text-success me-2"></i>Gmail Integration</li>
                                        <li><i class="bi bi-check-circle text-success me-2"></i>File Upload System</li>
                                        <li><i class="bi bi-check-circle text-success me-2"></i>Mobile Responsive</li>
                                        <li><i class="bi bi-check-circle text-success me-2"></i>Smart Sync</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/file-upload.js') }}?v={{ range(1000, 9999) | random }}"></script>
<script src="{{ url_for('static', filename='js/settings.js') }}?v={{ range(1000, 9999) | random }}"></script>
<script src="{{ url_for('static', filename='js/settings-helpers.js') }}?v={{ range(1000, 9999) | random }}"></script>
<script src="{{ url_for('static', filename='js/settings-extended.js') }}?v={{ range(1000, 9999) | random }}"></script>
<script src="{{ url_for('static', filename='js/settings-sync.js') }}?v={{ range(1000, 9999) | random }}"></script>
{% endblock %}
