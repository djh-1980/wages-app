{% extends "base.html" %}

{% block title %}Settings - TVS App{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/file-upload.css') }}?v={{ range(1000, 9999) | random }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/settings.css') }}?v={{ range(1000, 9999) | random }}">
{% endblock %}

{% block content %}
    <!-- Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1>
                    <i class="bi bi-gear text-primary"></i>
                    Settings
                </h1>
                <p>Manage your profile, preferences, and system configuration</p>
            </div>
            <div class="action-buttons">
                <button class="btn btn-outline-primary" onclick="loadAllSettings()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Navigation Cards -->
    <div class="row summary-cards settings-nav-cards mb-4">
        <div class="col-md-3 col-lg-2">
            <div class="card hover-lift" onclick="showSettingsSection('profile')" style="cursor: pointer;">
                <div class="card-body text-center">
                    <i class="bi bi-person-circle fs-1 text-primary mb-3"></i>
                    <h6 class="card-title mb-2">Profile</h6>
                    <p class="card-text small text-muted mb-0">Personal info & work details</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-lg-2">
            <div class="card hover-lift" onclick="showSettingsSection('sync')" style="cursor: pointer;">
                <div class="card-body text-center">
                    <i class="bi bi-arrow-repeat fs-1 text-success mb-3"></i>
                    <h6 class="card-title mb-2">Data & Sync</h6>
                    <p class="card-text small text-muted mb-0">Gmail sync & file management</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-lg-2">
            <div class="card hover-lift" onclick="showSettingsSection('attendance')" style="cursor: pointer;">
                <div class="card-body text-center">
                    <i class="bi bi-calendar-check fs-1 text-danger mb-3"></i>
                    <h6 class="card-title mb-2">Attendance</h6>
                    <p class="card-text small text-muted mb-0">Track absences & holidays</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-lg-2">
            <div class="card hover-lift" onclick="showSettingsSection('system')" style="cursor: pointer;">
                <div class="card-body text-center">
                    <i class="bi bi-gear-fill fs-1 text-warning mb-3"></i>
                    <h6 class="card-title mb-2">System</h6>
                    <p class="card-text small text-muted mb-0">Database & performance</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-lg-2">
            <div class="card hover-lift" onclick="showSettingsSection('about')" style="cursor: pointer;">
                <div class="card-body text-center">
                    <i class="bi bi-info-circle fs-1 text-info mb-3"></i>
                    <h6 class="card-title mb-2">About</h6>
                    <p class="card-text small text-muted mb-0">Version & system info</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Sections -->
    <div class="content-card">
        <div class="content-card-header unified-tabs">
            <ul class="nav nav-tabs card-header-tabs" id="settingsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab">
                        <i class="bi bi-person-circle"></i> Profile
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="sync-tab" data-bs-toggle="tab" data-bs-target="#sync" type="button" role="tab">
                        <i class="bi bi-arrow-repeat"></i> Data & Sync
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance" type="button" role="tab">
                        <i class="bi bi-calendar-check"></i> Attendance
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="system-tab" data-bs-toggle="tab" data-bs-target="#system" type="button" role="tab">
                        <i class="bi bi-gear-fill"></i> System
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="about-tab" data-bs-toggle="tab" data-bs-target="#about" type="button" role="tab">
                        <i class="bi bi-info-circle"></i> About
                    </button>
                </li>
            </ul>
        </div>
        <div class="content-card-body">
            <div class="tab-content" id="settingsTabContent">
                <!-- Profile Tab -->
                <div class="tab-pane fade show active" id="profile" role="tabpanel">
                    <div class="d-flex align-items-center mb-4">
                        <div class="bg-primary rounded-circle p-3 me-3">
                            <i class="bi bi-person-fill text-white fs-4"></i>
                        </div>
                        <div>
                            <h5 class="mb-0">Profile & Account</h5>
                            <small class="text-muted">Personal information and work details</small>
                        </div>
                    </div>
                    
                    <div class="row g-3 settings-form">
                        <div class="col-md-6">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="userName" placeholder="Daniel Hanson">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="userEmail" placeholder="your@email.com">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="userPhone" placeholder="+44 7XXX XXXXXX">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Hourly Rate (£)</label>
                            <input type="number" class="form-control" id="hourlyRate" placeholder="15.00" step="0.01">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Tax Code</label>
                            <input type="text" class="form-control" id="taxCode" placeholder="1257L">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Address</label>
                            <input type="text" class="form-control" id="userAddress" placeholder="Your address">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">NI Number</label>
                            <input type="text" class="form-control" id="niNumber" placeholder="AB123456C">
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="saveProfile()">
                            <i class="bi bi-save me-1"></i>Save Profile
                        </button>
                    </div>
                    
                    <div id="profileStatus" class="mt-3" style="display: none;"></div>
                </div>

                <!-- Data & Sync Tab -->
                <div class="tab-pane fade" id="sync" role="tabpanel">
                    <div class="d-flex align-items-center mb-4">
                        <div class="bg-success rounded-circle p-3 me-3">
                            <i class="bi bi-arrow-repeat text-white fs-4"></i>
                        </div>
                        <div>
                            <h5 class="mb-0">Data & Sync Management</h5>
                            <small class="text-muted">Gmail sync, file uploads, and data operations</small>
                        </div>
                    </div>

                    <!-- Sync Status Cards -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <i class="bi bi-clock-history text-primary fs-4"></i>
                                    <div class="mt-2">
                                        <small class="text-muted d-block">Last Sync</small>
                                        <span id="lastSyncTime" class="fw-semibold">Never</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <i class="bi bi-wifi text-success fs-4"></i>
                                    <div class="mt-2">
                                        <small class="text-muted d-block">Gmail Status</small>
                                        <span id="syncStatusBadge" class="fw-semibold">Checking...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <i class="bi bi-activity text-warning fs-4" id="syncActivityIcon"></i>
                                    <div class="mt-2">
                                        <small class="text-muted d-block">Sync Status</small>
                                        <span id="currentSyncStatus" class="fw-semibold">Idle</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <i class="bi bi-database text-info fs-4"></i>
                                    <div class="mt-2">
                                        <small class="text-muted d-block">Total Records</small>
                                        <span id="totalRecords" class="fw-semibold">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Periodic Sync Control -->
                    <div class="settings-card-section mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-clock me-2"></i>Automatic Sync</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <p class="mb-1">
                                        <strong>Automatic Sync (Every 30 Minutes)</strong>
                                        <span id="autoSyncBadge" class="badge bg-success ms-2" style="display: none;">
                                            <i class="bi bi-check-circle"></i> Active
                                        </span>
                                    </p>
                                    <small class="text-muted">Downloads and imports latest runsheet + payslip from Gmail automatically</small>
                                    <div id="nextSyncTime" class="mt-1" style="display: none;">
                                        <small class="text-info"><i class="bi bi-clock"></i> Next sync: <span id="nextSyncTimeValue">--:--</span></small>
                                    </div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="periodicSyncToggle" onchange="togglePeriodicSync()">
                                    <label class="form-check-label" for="periodicSyncToggle">
                                        <span id="periodicSyncLabel">Enable</span>
                                    </label>
                                </div>
                            </div>
                            <div id="periodicSyncInfo" class="alert alert-info" style="display: none;">
                                <small>
                                    <i class="bi bi-info-circle me-1"></i>
                                    <strong>Auto-Sync Active:</strong> Checks Gmail every 30 minutes for the latest runsheet and payslip, then automatically imports them to the database.
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Manual Sync Actions -->
                    <div class="row g-3 mb-4 settings-actions">
                        <div class="col-md-6">
                            <button class="btn btn-primary btn-lg w-100" onclick="syncLatest()">
                                <i class="bi bi-cloud-download me-2"></i>Sync Latest from Gmail
                            </button>
                            <small class="text-muted d-block mt-2 text-center">Downloads and imports latest runsheet + payslip</small>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-outline-primary btn-lg w-100" onclick="forceSync()">
                                <i class="bi bi-lightning me-2"></i>Force Sync Now
                            </button>
                            <small class="text-muted d-block mt-2 text-center">Triggers auto-sync immediately (if enabled)</small>
                        </div>
                    </div>
                    
                    <div id="syncDataStatus" class="mb-4" style="display: none;"></div>

                    <!-- File Upload Section -->
                    <div class="settings-card-section">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-cloud-upload me-2"></i>Manual File Upload</h6>
                        </div>
                        <div class="card-body">
                            <div id="fileUploadContainer"></div>
                        </div>
                    </div>

                    <!-- Local File Management -->
                    <div class="settings-card-section">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-folder2-open me-2"></i>Local File Management</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3 mb-3">
                                <div class="col-md-4">
                                    <select class="form-select" id="localFileType">
                                        <option value="all">All Files</option>
                                        <option value="payslips">Payslips Only</option>
                                        <option value="runsheets">Runsheets Only</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select" id="localDaysBack">
                                        <option value="7">Last 7 days</option>
                                        <option value="14">Last 14 days</option>
                                        <option value="30">Last 30 days</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-outline-primary w-100" onclick="processLocalFiles()">
                                        <i class="bi bi-play-circle"></i> Process Local Files
                                    </button>
                                </div>
                            </div>
                            <div id="localFilesResults" style="display: none;"></div>
                        </div>
                    </div>

                    <!-- Gmail Connection Test -->
                    <div class="settings-card-section">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-envelope me-2"></i>Gmail Connection</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="mb-1">Test your Gmail API connection</p>
                                    <small class="text-muted">Verify credentials and authentication status</small>
                                </div>
                                <button type="button" class="btn btn-outline-success" onclick="testGmailConnection()">
                                    <i class="bi bi-wifi"></i> Test Connection
                                </button>
                            </div>
                            <div id="gmailTestResults" class="mt-3" style="display: none;"></div>
                        </div>
                    </div>
                </div>

                <!-- Attendance Tab -->
                <div class="tab-pane fade" id="attendance" role="tabpanel">
                    <div class="d-flex align-items-center mb-4">
                        <div class="bg-danger rounded-circle p-3 me-3">
                            <i class="bi bi-calendar-check text-white fs-4"></i>
                        </div>
                        <div>
                            <h5 class="mb-0">Attendance Tracking</h5>
                            <small class="text-muted">Track days you didn't work (holidays, sick days, absences)</small>
                        </div>
                    </div>

                    <!-- Add Attendance Record -->
                    <div class="settings-card-section mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Add Attendance Record</h6>
                        </div>
                        <div class="card-body">
                            <!-- Toggle between single and range -->
                            <div class="btn-group mb-3" role="group">
                                <input type="radio" class="btn-check" name="attendanceMode" id="singleDayMode" checked onchange="toggleAttendanceMode()">
                                <label class="btn btn-outline-primary" for="singleDayMode">
                                    <i class="bi bi-calendar-event"></i> Single Day
                                </label>
                                
                                <input type="radio" class="btn-check" name="attendanceMode" id="rangeDayMode" onchange="toggleAttendanceMode()">
                                <label class="btn btn-outline-primary" for="rangeDayMode">
                                    <i class="bi bi-calendar-range"></i> Date Range
                                </label>
                            </div>

                            <!-- Single Day Form -->
                            <div id="singleDayForm">
                                <div class="row g-3 mb-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Date</label>
                                        <input type="date" class="form-control" id="attendanceDate">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Reason</label>
                                        <select class="form-select" id="attendanceReason">
                                            <option value="Holiday">Holiday</option>
                                            <option value="Sick">Sick Day</option>
                                            <option value="Personal">Personal Day</option>
                                            <option value="Training">Training</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Notes (Optional)</label>
                                        <input type="text" class="form-control" id="attendanceNotes" placeholder="Additional notes...">
                                    </div>
                                </div>
                                <button class="btn btn-primary" onclick="addAttendanceRecord()">
                                    <i class="bi bi-plus-circle me-1"></i>Add Record
                                </button>
                            </div>

                            <!-- Date Range Form -->
                            <div id="rangeDayForm" style="display: none;">
                                <div class="row g-3 mb-3">
                                    <div class="col-md-3">
                                        <label class="form-label">From Date</label>
                                        <input type="date" class="form-control" id="attendanceDateFrom">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">To Date</label>
                                        <input type="date" class="form-control" id="attendanceDateTo">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Reason</label>
                                        <select class="form-select" id="attendanceReasonRange">
                                            <option value="Holiday">Holiday</option>
                                            <option value="Sick">Sick Day</option>
                                            <option value="Personal">Personal Day</option>
                                            <option value="Training">Training</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Notes (Optional)</label>
                                        <input type="text" class="form-control" id="attendanceNotesRange" placeholder="Additional notes...">
                                    </div>
                                </div>
                                <button class="btn btn-primary" onclick="addAttendanceRange()">
                                    <i class="bi bi-calendar-plus me-1"></i>Add Date Range
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Attendance Records List -->
                    <div class="settings-card-section">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="bi bi-list-ul me-2"></i>Attendance Records</h6>
                                <select class="form-select form-select-sm" id="attendanceYearFilter" style="width: auto;" onchange="loadAttendanceRecords()">
                                    <option value="">All Years</option>
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="attendanceRecordsList">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p class="mt-2 text-muted">Loading records...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Tab -->
                <div class="tab-pane fade" id="system" role="tabpanel">
                    <div class="d-flex align-items-center mb-4">
                        <div class="bg-warning rounded-circle p-3 me-3">
                            <i class="bi bi-gear-fill text-white fs-4"></i>
                        </div>
                        <div>
                            <h5 class="mb-0">System Settings</h5>
                            <small class="text-muted">Database management and system configuration</small>
                        </div>
                    </div>

                    <!-- Database Stats -->
                    <div class="settings-card-section">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-database me-2"></i>Database Statistics</h6>
                        </div>
                        <div class="card-body">
                            <div class="db-stats-grid">
                                <div class="db-stat-item">
                                    <div class="db-stat-value text-primary" id="dbPayslips">-</div>
                                    <div class="db-stat-label">Payslips</div>
                                </div>
                                <div class="db-stat-item">
                                    <div class="db-stat-value text-success" id="dbRunSheets">-</div>
                                    <div class="db-stat-label">Run Sheets</div>
                                </div>
                                <div class="db-stat-item">
                                    <div class="db-stat-value text-info" id="dbJobs">-</div>
                                    <div class="db-stat-label">Jobs</div>
                                </div>
                                <div class="db-stat-item">
                                    <div class="db-stat-value text-warning" id="dbSize">-</div>
                                    <div class="db-stat-label">DB Size</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- System Actions -->
                    <div class="settings-card-section">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-tools me-2"></i>System Actions</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3 settings-actions">
                                <div class="col-md-6">
                                    <button class="btn btn-outline-primary w-100" onclick="backupDatabase()">
                                        <i class="bi bi-download me-2"></i>Backup Database
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button class="btn btn-outline-warning w-100" onclick="clearCache()">
                                        <i class="bi bi-trash me-2"></i>Clear Cache
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- About Tab -->
                <div class="tab-pane fade" id="about" role="tabpanel">
                    <div class="d-flex align-items-center mb-4">
                        <div class="bg-info rounded-circle p-3 me-3">
                            <i class="bi bi-info-circle text-white fs-4"></i>
                        </div>
                        <div>
                            <h5 class="mb-0">About TVS Wages</h5>
                            <small class="text-muted">Application information and system details</small>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <h6>Application Info</h6>
                                    <table class="table table-sm">
                                        <tr><td>Version:</td><td>2.0.0</td></tr>
                                        <tr><td>Build:</td><td>2025.11.12</td></tr>
                                        <tr><td>Environment:</td><td>Production</td></tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h6>Features</h6>
                                    <ul class="list-unstyled">
                                        <li><i class="bi bi-check-circle text-success me-2"></i>Gmail Integration</li>
                                        <li><i class="bi bi-check-circle text-success me-2"></i>File Upload System</li>
                                        <li><i class="bi bi-check-circle text-success me-2"></i>Mobile Responsive</li>
                                        <li><i class="bi bi-check-circle text-success me-2"></i>Smart Sync</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/file-upload.js') }}?v={{ range(1000, 9999) | random }}"></script>
<script src="{{ url_for('static', filename='js/settings.js') }}?v={{ range(1000, 9999) | random }}"></script>
<script>
// Settings page functionality
function showSettingsSection(section) {
    document.getElementById(section + '-tab').click();
}

// File management functions
async function hybridSync() {
    try {
        showStatus('Running smart sync...');
        const result = await HybridSyncManager.hybridSync('smart');
        showResults('Smart Sync Complete', result);
        hideStatus();
    } catch (error) {
        showError(`Smart sync failed: ${error.message}`);
        hideStatus();
    }
}

async function processLocalFiles() {
    try {
        const fileType = document.getElementById('localFileType').value;
        const daysBack = parseInt(document.getElementById('localDaysBack').value);
        
        showStatus('Processing local files...');
        const result = await HybridSyncManager.processLocalFiles({
            type: fileType,
            days_back: daysBack
        });
        
        document.getElementById('localFilesResults').innerHTML = `
            <div class="alert alert-${result.success ? 'success' : 'danger'}">
                <i class="bi bi-${result.success ? 'check-circle' : 'x-circle'}"></i>
                Processing ${result.success ? 'completed' : 'failed'}
            </div>
        `;
        document.getElementById('localFilesResults').style.display = 'block';
        hideStatus();
    } catch (error) {
        showError(`Processing failed: ${error.message}`);
        hideStatus();
    }
}

async function testGmailConnection() {
    try {
        showStatus('Testing Gmail connection...');
        const response = await fetch('/api/gmail/test-connection', { method: 'POST' });
        const result = await response.json();
        
        const resultsDiv = document.getElementById('gmailTestResults');
        if (result.success) {
            resultsDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i>
                    Gmail connected successfully! Email: ${result.email}
                </div>
            `;
        } else {
            resultsDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle"></i>
                    Connection failed: ${result.error}
                </div>
            `;
        }
        resultsDiv.style.display = 'block';
        hideStatus();
    } catch (error) {
        showError(`Connection test failed: ${error.message}`);
        hideStatus();
    }
}

// Enhanced sync functions with real-time status
async function syncPayslips() {
    try {
        updateSyncStatus('Running', 'Syncing payslips from Gmail...');
        
        const response = await fetch('/api/data/sync-payslips', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            updateSyncStatus('Complete', 'Payslips synced successfully');
            showSuccess('✅ Payslips synced successfully!');
            updateLastSyncTime();
            loadDatabaseStats(); // Refresh stats
        } else {
            updateSyncStatus('Error', 'Payslip sync failed');
            showError(`❌ Sync failed: ${result.error}`);
        }
    } catch (error) {
        updateSyncStatus('Error', 'Connection error');
        showError(`❌ Sync failed: ${error.message}`);
    }
}

async function syncLatest() {
    try {
        updateSyncStatus('Running', 'Syncing latest from Gmail...');
        
        const response = await fetch('/api/data/sync-runsheets', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            updateSyncStatus('Complete', 'Latest files synced successfully');
            showSuccess('✅ Latest runsheet + payslip synced successfully!');
            updateLastSyncTime();
            loadDatabaseStats(); // Refresh stats
        } else {
            updateSyncStatus('Error', 'Sync failed');
            showError(`❌ Sync failed: ${result.error}`);
        }
    } catch (error) {
        updateSyncStatus('Error', 'Connection error');
        showError(`❌ Sync failed: ${error.message}`);
    }
}

async function syncRunSheets() {
    try {
        updateSyncStatus('Running', 'Syncing run sheets from Gmail...');
        
        const response = await fetch('/api/data/sync-runsheets', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            updateSyncStatus('Complete', 'Run sheets synced successfully');
            showSuccess('✅ Run sheets synced successfully!');
            updateLastSyncTime();
            loadDatabaseStats(); // Refresh stats
        } else {
            updateSyncStatus('Error', 'Run sheet sync failed');
            showError(`❌ Sync failed: ${result.error}`);
        }
    } catch (error) {
        updateSyncStatus('Error', 'Connection error');
        showError(`❌ Sync failed: ${error.message}`);
    }
}

function saveProfile() {
    showSuccess('Profile saved successfully!');
}

function backupDatabase() {
    showSuccess('Database backup initiated!');
}

function clearCache() {
    showSuccess('Cache cleared successfully!');
}

function loadAllSettings() {
    // Load database stats
    loadDatabaseStats();
    // Load sync status
    loadSyncStatus();
    // Load periodic sync status
    loadPeriodicSyncStatus();
}

// Periodic sync functions
async function loadPeriodicSyncStatus() {
    try {
        const response = await fetch('/api/data/periodic-sync/status');
        const status = await response.json();
        
        if (status.success) {
            const toggle = document.getElementById('periodicSyncToggle');
            const label = document.getElementById('periodicSyncLabel');
            const info = document.getElementById('periodicSyncInfo');
            const badge = document.getElementById('autoSyncBadge');
            const nextSyncDiv = document.getElementById('nextSyncTime');
            const nextSyncValue = document.getElementById('nextSyncTimeValue');
            
            toggle.checked = status.is_running;
            label.textContent = status.is_running ? 'Enabled' : 'Disabled';
            
            if (status.is_running) {
                info.style.display = 'block';
                badge.style.display = 'inline-block';
                
                // Show next sync time if available
                if (status.next_sync_estimate) {
                    const nextSync = new Date(status.next_sync_estimate);
                    nextSyncValue.textContent = nextSync.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                    nextSyncDiv.style.display = 'block';
                }
            } else {
                info.style.display = 'none';
                badge.style.display = 'none';
                nextSyncDiv.style.display = 'none';
            }
        }
    } catch (error) {
        console.error('Failed to load periodic sync status:', error);
    }
}

async function togglePeriodicSync() {
    const toggle = document.getElementById('periodicSyncToggle');
    const label = document.getElementById('periodicSyncLabel');
    
    try {
        const action = toggle.checked ? 'start' : 'stop';
        const response = await fetch(`/api/data/periodic-sync/${action}`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            label.textContent = toggle.checked ? 'Enabled' : 'Disabled';
            showSuccess(`Periodic sync ${toggle.checked ? 'enabled' : 'disabled'}`);
            loadPeriodicSyncStatus();
            
            // Update navbar badge immediately
            if (typeof checkAutoSyncStatus === 'function') {
                checkAutoSyncStatus();
            }
        } else {
            // Revert toggle on error
            toggle.checked = !toggle.checked;
            showError('Failed to toggle periodic sync');
        }
    } catch (error) {
        // Revert toggle on error
        toggle.checked = !toggle.checked;
        showError(`Failed to toggle periodic sync: ${error.message}`);
    }
}

async function forceSync() {
    try {
        updateSyncStatus('Running', 'Force syncing all recent files...');
        
        const response = await fetch('/api/data/periodic-sync/force', { method: 'POST' });
        const result = await response.json();
        
        if (result.success) {
            updateSyncStatus('Complete', 'Force sync initiated');
            showSuccess('⚡ Force sync started in background - check status above');
            updateLastSyncTime();
            
            // Refresh stats after a delay
            setTimeout(() => {
                loadDatabaseStats();
            }, 5000);
        } else {
            updateSyncStatus('Error', 'Force sync failed');
            showError(`❌ Force sync failed: ${result.error}`);
        }
    } catch (error) {
        updateSyncStatus('Error', 'Connection error');
        showError(`❌ Force sync failed: ${error.message}`);
    }
}

async function loadDatabaseStats() {
    try {
        const response = await fetch('/api/data/stats');
        const stats = await response.json();
        
        if (stats.success) {
            document.getElementById('dbPayslips').textContent = stats.payslips || '-';
            document.getElementById('dbRunSheets').textContent = stats.runsheets || '-';
            document.getElementById('dbJobs').textContent = stats.jobs || '-';
            document.getElementById('dbSize').textContent = stats.size || '-';
            document.getElementById('totalRecords').textContent = stats.total_records || '-';
        }
    } catch (error) {
        console.error('Failed to load database stats:', error);
        // Set fallback values
        document.getElementById('dbPayslips').textContent = '-';
        document.getElementById('dbRunSheets').textContent = '-';
        document.getElementById('dbJobs').textContent = '-';
        document.getElementById('dbSize').textContent = '-';
        document.getElementById('totalRecords').textContent = '-';
    }
}

async function loadSyncStatus() {
    try {
        const response = await fetch('/api/gmail/status');
        const status = await response.json();
        
        const badge = document.getElementById('syncStatusBadge');
        if (status.configured && status.authenticated) {
            badge.textContent = 'Connected';
            badge.className = 'fw-semibold text-success';
        } else {
            badge.textContent = 'Not Connected';
            badge.className = 'fw-semibold text-danger';
        }
    } catch (error) {
        console.error('Failed to load sync status:', error);
    }
}

// Utility functions
function updateSyncStatus(status, message) {
    const statusElement = document.getElementById('currentSyncStatus');
    const iconElement = document.getElementById('syncActivityIcon');
    
    statusElement.textContent = status;
    
    // Update icon and color based on status
    switch(status) {
        case 'Running':
            iconElement.className = 'bi bi-arrow-repeat text-primary fs-4';
            iconElement.style.animation = 'spin 1s linear infinite';
            statusElement.className = 'fw-semibold text-primary';
            break;
        case 'Complete':
            iconElement.className = 'bi bi-check-circle text-success fs-4';
            iconElement.style.animation = 'none';
            statusElement.className = 'fw-semibold text-success';
            // Auto-reset to idle after 5 seconds
            setTimeout(() => updateSyncStatus('Idle', ''), 5000);
            break;
        case 'Error':
            iconElement.className = 'bi bi-x-circle text-danger fs-4';
            iconElement.style.animation = 'none';
            statusElement.className = 'fw-semibold text-danger';
            // Auto-reset to idle after 10 seconds
            setTimeout(() => updateSyncStatus('Idle', ''), 10000);
            break;
        default: // Idle
            iconElement.className = 'bi bi-activity text-warning fs-4';
            iconElement.style.animation = 'none';
            statusElement.className = 'fw-semibold';
            break;
    }
}

function updateLastSyncTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-GB', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: false 
    });
    document.getElementById('lastSyncTime').textContent = timeString;
}

function showStatus(message) {
    console.log('Status:', message);
}

function hideStatus() {
    // Hide status display
}

function showSuccess(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alert.innerHTML = `
        <i class="bi bi-check-circle"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    setTimeout(() => alert.remove(), 5000);
}

function showError(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-danger alert-dismissible fade show position-fixed';
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alert.innerHTML = `
        <i class="bi bi-exclamation-triangle"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    setTimeout(() => alert.remove(), 8000);
}

// Attendance functions
function toggleAttendanceMode() {
    const singleMode = document.getElementById('singleDayMode').checked;
    document.getElementById('singleDayForm').style.display = singleMode ? 'block' : 'none';
    document.getElementById('rangeDayForm').style.display = singleMode ? 'none' : 'block';
}

async function loadAttendanceRecords() {
    const year = document.getElementById('attendanceYearFilter').value;
    const listDiv = document.getElementById('attendanceRecordsList');
    
    try {
        listDiv.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">Loading records...</p>
            </div>
        `;
        
        const url = year ? `/api/attendance?year=${year}` : '/api/attendance';
        const response = await fetch(url);
        const records = await response.json();
        
        if (records.length === 0) {
            listDiv.innerHTML = `
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-calendar-x fs-1"></i>
                    <p class="mt-2">No attendance records found</p>
                </div>
            `;
            return;
        }
        
        // Helper function to parse DD/MM/YYYY format
        const parseDate = (dateStr) => {
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                // DD/MM/YYYY format
                return new Date(parts[2], parts[1] - 1, parts[0]);
            }
            // Fallback to standard parsing
            return new Date(dateStr);
        };
        
        // Sort records by date
        records.sort((a, b) => parseDate(a.date) - parseDate(b.date));
        
        // Group consecutive days with same reason
        const groups = [];
        let currentGroup = null;
        
        records.forEach(record => {
            // Parse date properly - handle DD/MM/YYYY format
            const recordDate = parseDate(record.date);
            
            if (!currentGroup) {
                currentGroup = {
                    startDate: recordDate,
                    endDate: recordDate,
                    reason: record.reason,
                    notes: record.notes,
                    ids: [record.id],
                    records: [record]
                };
            } else {
                const lastDate = currentGroup.endDate;
                const daysDiff = Math.round((recordDate - lastDate) / (1000 * 60 * 60 * 24));
                
                // If consecutive day and same reason, add to current group
                if (daysDiff === 1 && record.reason === currentGroup.reason) {
                    currentGroup.endDate = recordDate;
                    currentGroup.ids.push(record.id);
                    currentGroup.records.push(record);
                    // Append notes if different
                    if (record.notes && record.notes !== currentGroup.notes) {
                        currentGroup.notes = currentGroup.notes ? 
                            `${currentGroup.notes}; ${record.notes}` : record.notes;
                    }
                } else {
                    // Start new group
                    groups.push(currentGroup);
                    currentGroup = {
                        startDate: recordDate,
                        endDate: recordDate,
                        reason: record.reason,
                        notes: record.notes,
                        ids: [record.id],
                        records: [record]
                    };
                }
            }
        });
        
        // Push last group
        if (currentGroup) {
            groups.push(currentGroup);
        }
        
        // Render groups
        const reasonColors = {
            'Holiday': 'success',
            'Sick': 'danger',
            'Personal': 'warning',
            'Training': 'info',
            'Other': 'secondary'
        };
        
        let html = '<div class="list-group">';
        groups.forEach(group => {
            const color = reasonColors[group.reason] || 'secondary';
            const isRange = group.startDate.getTime() !== group.endDate.getTime();
            const dayCount = group.ids.length;
            
            let dateDisplay;
            if (isRange) {
                const startStr = group.startDate.toLocaleDateString('en-GB', { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric' 
                });
                const endStr = group.endDate.toLocaleDateString('en-GB', { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric',
                    year: 'numeric'
                });
                dateDisplay = `${startStr} - ${endStr}`;
            } else {
                dateDisplay = group.startDate.toLocaleDateString('en-GB', { 
                    weekday: 'short', 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
            }
            
            html += `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">
                                <i class="bi bi-calendar-${isRange ? 'range' : 'event'} me-2"></i>${dateDisplay}
                            </h6>
                            <div class="mb-2">
                                <span class="badge bg-${color}">${group.reason}</span>
                                ${isRange ? `<span class="badge bg-secondary ms-1">${dayCount} day${dayCount > 1 ? 's' : ''}</span>` : ''}
                                ${group.notes ? `<small class="text-muted ms-2">${group.notes}</small>` : ''}
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteAttendanceGroup([${group.ids.join(',')}])">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    ${isRange ? `
                        <details class="mt-2">
                            <summary class="text-muted small" style="cursor: pointer;">
                                <i class="bi bi-chevron-down me-1"></i>Show individual days
                            </summary>
                            <div class="mt-2 ms-3">
                                ${group.records.map(r => {
                                    const parts = r.date.split('/');
                                    const d = new Date(parts[2], parts[1] - 1, parts[0]);
                                    return `<small class="d-block text-muted">• ${d.toLocaleDateString('en-GB', { weekday: 'short', month: 'short', day: 'numeric' })}</small>`;
                                }).join('')}
                            </div>
                        </details>
                    ` : ''}
                </div>
            `;
        });
        html += '</div>';
        
        listDiv.innerHTML = html;
    } catch (error) {
        listDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> Failed to load records: ${error.message}
            </div>
        `;
    }
}

async function addAttendanceRecord() {
    const date = document.getElementById('attendanceDate').value;
    const reason = document.getElementById('attendanceReason').value;
    const notes = document.getElementById('attendanceNotes').value;
    
    if (!date) {
        showError('Please select a date');
        return;
    }
    
    // Convert YYYY-MM-DD to DD/MM/YYYY
    const parts = date.split('-');
    const formattedDate = `${parts[2]}/${parts[1]}/${parts[0]}`;
    
    try {
        const response = await fetch('/api/attendance', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ date: formattedDate, reason, notes })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess('✅ Attendance record added');
            document.getElementById('attendanceDate').value = '';
            document.getElementById('attendanceNotes').value = '';
            loadAttendanceRecords();
        } else {
            showError(`Failed to add record: ${result.error}`);
        }
    } catch (error) {
        showError(`Failed to add record: ${error.message}`);
    }
}

async function addAttendanceRange() {
    const dateFrom = document.getElementById('attendanceDateFrom').value;
    const dateTo = document.getElementById('attendanceDateTo').value;
    const reason = document.getElementById('attendanceReasonRange').value;
    const notes = document.getElementById('attendanceNotesRange').value;
    
    if (!dateFrom || !dateTo) {
        showError('Please select both from and to dates');
        return;
    }
    
    const fromDate = new Date(dateFrom);
    const toDate = new Date(dateTo);
    
    if (fromDate > toDate) {
        showError('From date must be before or equal to To date');
        return;
    }
    
    // Calculate number of days
    const dayCount = Math.round((toDate - fromDate) / (1000 * 60 * 60 * 24)) + 1;
    
    if (dayCount > 365) {
        showError('Date range cannot exceed 365 days');
        return;
    }
    
    try {
        // Generate all dates in range
        const dates = [];
        const currentDate = new Date(fromDate);
        
        while (currentDate <= toDate) {
            const day = String(currentDate.getDate()).padStart(2, '0');
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            const year = currentDate.getFullYear();
            dates.push(`${day}/${month}/${year}`);
            currentDate.setDate(currentDate.getDate() + 1);
        }
        
        // Add all records
        const addPromises = dates.map(date =>
            fetch('/api/attendance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date, reason, notes })
            })
        );
        
        await Promise.all(addPromises);
        
        showSuccess(`✅ Added ${dayCount} attendance record${dayCount > 1 ? 's' : ''}`);
        document.getElementById('attendanceDateFrom').value = '';
        document.getElementById('attendanceDateTo').value = '';
        document.getElementById('attendanceNotesRange').value = '';
        loadAttendanceRecords();
    } catch (error) {
        showError(`Failed to add records: ${error.message}`);
    }
}

async function deleteAttendanceRecord(id) {
    if (!confirm('Are you sure you want to delete this attendance record?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/attendance/${id}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess('✅ Record deleted');
            loadAttendanceRecords();
        } else {
            showError(`Failed to delete record: ${result.error}`);
        }
    } catch (error) {
        showError(`Failed to delete record: ${error.message}`);
    }
}

async function deleteAttendanceGroup(ids) {
    const count = ids.length;
    const message = count > 1 ? 
        `Are you sure you want to delete these ${count} attendance records?` :
        'Are you sure you want to delete this attendance record?';
    
    if (!confirm(message)) {
        return;
    }
    
    try {
        // Delete all records in the group
        const deletePromises = ids.map(id => 
            fetch(`/api/attendance/${id}`, { method: 'DELETE' })
        );
        
        await Promise.all(deletePromises);
        
        showSuccess(`✅ ${count} record${count > 1 ? 's' : ''} deleted`);
        loadAttendanceRecords();
    } catch (error) {
        showError(`Failed to delete records: ${error.message}`);
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadAllSettings();
    loadAttendanceRecords();
});
</script>
{% endblock %}
